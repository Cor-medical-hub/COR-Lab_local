<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="./css/reset.css">
    <link rel="stylesheet" href="./css/general.css">
    <link rel="stylesheet" href="./css/infoPlate.css">
    <link rel="stylesheet" href="./css/comments.css">
    <link rel="stylesheet" href="./css/header.css">
    <link rel="stylesheet" href="./css/glass.css">
    <link rel="stylesheet" href="./css/conclusion.css">
    <link rel="stylesheet" href="./css/doctorSign.css">
    <link rel="stylesheet" href="./css/modal.css">
    <link rel="stylesheet" href="./COR_ID_css/modal.css">
</head>
<body>

<div class="glassPageWrapper df fdc">
    <div class="header-container">
        <div class="header-row top">
            <div class="search-container">
                <input type="text" placeholder="Search">
                <svg class="search-icon" width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M11.2 5.60001C8.10722 5.60001 5.60001 8.10722 5.60001 11.2C5.60001 14.2928 8.10722 16.8001 11.2 16.8001C12.7087 16.8001 14.0781 16.2035 15.085 15.2333C15.1061 15.2058 15.1292 15.1794 15.1544 15.1543C15.1795 15.1291 15.2059 15.106 15.2334 15.0849C16.2035 14.078 16.8 12.7087 16.8 11.2C16.8 8.10722 14.2928 5.60001 11.2 5.60001ZM16.8256 15.6942C17.8109 14.4624 18.4001 12.9 18.4001 11.2C18.4001 7.22357 15.1765 4 11.2 4C7.22356 4 4 7.22357 4 11.2C4 15.1765 7.22356 18.4001 11.2 18.4001C12.9001 18.4001 14.4625 17.8109 15.6942 16.8255L18.6344 19.7657C18.9468 20.0781 19.4533 20.0781 19.7658 19.7657C20.0782 19.4533 20.0782 18.9467 19.7658 18.6343L16.8256 15.6942Z" fill="#B1A1DA"/>
                </svg>
            </div>
            <div class="role-container">
                <button class="role-icon" id="goToCases" aria-label="User roles">
                    <svg class="icon-group" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M14.2666 11.1279C16.1699 11.128 17.7128 12.6709 17.7129 14.5742V20.4512C17.7127 20.8636 17.3783 21.1982 16.9658 21.1982H7.03418C6.62172 21.1982 6.28734 20.8636 6.28711 20.4512V14.5742C6.28721 12.6709 7.83002 11.1279 9.7334 11.1279H14.2666ZM5.53516 13.1729C5.38681 13.6154 5.28731 14.0804 5.28711 14.5723H3.44629C2.31795 14.5724 1.40039 15.4908 1.40039 16.6191V19.7979H5.28711V20.4502C5.28711 20.7184 5.35253 20.97 5.46094 21.1973H0.74707C0.334473 21.1973 0 20.8628 0 20.4502V16.6191C0 14.7158 1.54293 13.173 3.44629 13.1729H5.53516ZM20.5537 13.1729C22.457 13.173 24 14.7158 24 16.6191V20.4502C24 20.8628 23.6655 21.1972 23.2529 21.1973H18.5391C18.6475 20.97 18.7129 20.7183 18.7129 20.4502V19.7979H22.5996V16.6191C22.5996 15.4908 21.682 14.5724 20.5537 14.5723H18.7129C18.7127 14.0804 18.6132 13.6154 18.4648 13.1729H20.5537ZM9.7334 12.5283C8.60504 12.5283 7.68662 13.4459 7.68652 14.5742V19.7979H16.3125V14.5742C16.3124 13.4459 15.3949 12.5284 14.2666 12.5283H9.7334ZM4.55273 6.53711C6.13959 6.53711 7.42568 7.82339 7.42578 9.41016C7.42578 10.9971 6.13965 12.2832 4.55273 12.2832C2.96597 12.2831 1.67969 10.997 1.67969 9.41016C1.67979 7.82345 2.96603 6.53721 4.55273 6.53711ZM19.4473 6.53711C21.0339 6.53724 22.3202 7.82347 22.3203 9.41016C22.3203 10.997 21.034 12.2831 19.4473 12.2832C17.8604 12.2832 16.5742 10.9971 16.5742 9.41016C16.5743 7.82339 17.8605 6.53711 19.4473 6.53711ZM4.55273 7.9375C3.74056 7.9376 3.08018 8.59798 3.08008 9.41016C3.08008 10.2225 3.7405 10.8837 4.55273 10.8838C5.36511 10.8838 6.02637 10.2225 6.02637 9.41016C6.02627 8.59792 5.36505 7.9375 4.55273 7.9375ZM19.4473 7.9375C18.6349 7.9375 17.9737 8.59792 17.9736 9.41016C17.9736 10.2225 18.6349 10.8838 19.4473 10.8838C20.2595 10.8837 20.9199 10.2225 20.9199 9.41016C20.9198 8.598 20.2594 7.93763 19.4473 7.9375ZM12 2.80273C13.991 2.80283 15.6053 4.41628 15.6055 6.40723C15.6055 8.39832 13.9911 10.0126 12 10.0127C10.0089 10.0127 8.39453 8.39838 8.39453 6.40723C8.3947 4.41622 10.009 2.80273 12 2.80273ZM12 4.20215C10.7841 4.20215 9.79509 5.19136 9.79492 6.40723C9.79492 7.62323 10.784 8.61328 12 8.61328C13.2159 8.61318 14.2051 7.62317 14.2051 6.40723C14.2049 5.19142 13.2158 4.20225 12 4.20215Z" fill="#7527B2"/>
                    </svg>
                </button>
                <div class="role-toggle">
                    <button class="role-btn doc active">Лікар</button>
                    <button class="role-btn lab">Лаборант</button>
                </div>
            </div>
        </div>
        <div class="header-row bottom">
            <div>
                <div class="tabs">
                    <button class="tab directionPage">Направлення</button>
                    <button class="tab tenderloinPage">Вирізка</button>
                    <button class="tab glassPage">Скельця</button>
                    <button class="tab conclusionPage active">Заключення</button>
                    <button class="tab explorationPage">Дослідження</button>
                </div>
            </div>
            <div class="meta-info">
                <div id="reportOwnerInfo">
                </div>
                <div>
                    <span id="searchCaseId"></span>
                    <button class="edit-btn" aria-label="Edit case">
                        <svg class="icon-edit" viewBox="0 0 24 24">
                            <path d="M4 20h16"/>
                            <path d="M14.7 5.3l4 4L9 19.3l-4-4L14.7 5.3z"/>
                        </svg>
                    </button>
                </div>
                <div id="userName"></div>
                <div id="userGender"></div>
                <div id="userAge"></div>
            </div>
        </div>
    </div>
    <div class="glassPageContent df jcsb">
        <div class="left">
            <div class="top borderRadiusLeft df aic">
                <div class="glassPageRevert" style="display: none">
                    <img src="./assets/arrow.svg" alt="arrow">
                </div>
                <div>
                    Поточні кейси
                </div>
            </div>
            <div class="bottom">
                <div id="caseItems" class="caseItems">

                </div>
            </div>
        </div>
        <div class="middle df fdc">
            <div class="top df aic">
                Заключення
            </div>
            <div class="bottom df ">
                <div class="conclusionContent">
                    <div id="reportWrapper">

                    </div>
                </div>
                <div class="glassContent df" id="reportGlassWrapper">

                </div>
            </div>
        </div>
    </div>
</div>

<script src="./COR_ID_Js/general_fun.js"></script>
<script src="./js/general.js"></script>
<script src="./js/alert.js"></script>
<script>
    const PATIENT_COR_ID = new URLSearchParams(window.location.search).get('userCorId')
    const INITIAL_CASE_ID = new URLSearchParams(window.location.search).get('caseId')
    const myCorId = decodeTokenJWT(localStorage.getItem('access_token'))?.corid

    let currentUserCorId = PATIENT_COR_ID || null;
    let currentCaseOwner = null;
    let currentCase = null;
    let currentReport = null;
    let currentAllGlasses = null;
    let activeGlasses = []

    const reportOwnerInfoNODE = document.querySelector('#reportOwnerInfo')
    const reportGlassWrapperNODE = document.querySelector('#reportGlassWrapper')
    const reportWrapperNODE = document.querySelector('#reportWrapper')
    const caseContentNODE = document.querySelector("#caseItems");
    const caseLabelNode = document.querySelector('#searchCaseId');

    const changeUrlParams = () => {
        const url = new URL(window.location);
        const params = new URLSearchParams(url.search);

        params.set('caseId', currentCase?.id);

        window.history.replaceState(null, '', `${url.pathname}?${params}`);
    }

    const setOwnerInfo = (caseOwner) => {
        const caseIsClosed = currentCase?.grossing_status === "COMPLETED";
        const hasOwner = caseOwner?.id
        reportOwnerInfoNODE.innerHTML = ""

        if (hasOwner) {
            console.log('11111')
            if (!caseOwner?.is_case_owner || caseIsClosed) {
                const div = document.createElement('div')
                div.innerHTML = `Власник: ${getShortName(caseOwner.last_name, caseOwner.first_name, caseOwner.middle_name)}`;
                div.classList = "caseBtnOwner owner";
                div.style.marginBottom = 0;

                reportOwnerInfoNODE.append(div)
            }

            if (caseOwner?.is_case_owner && !caseIsClosed) {
                console.log('333333')

                const div = document.createElement('div')
                div.innerText = "Власний кейс";
                div.classList = "caseBtnOwner my";
                div.style.marginBottom = 0;

                div.addEventListener('click', (e) => {
                    if(checkToken()){
                        fetch(`${API_BASE_URL}/api/cases/${currentCase.id}/release`, {
                            method: "POST",
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                                "Content-Type": "application/json"
                            },
                        })
                            .then(res => res.json())
                            .then(({case_owner}) => {
                                currentCaseOwner = case_owner;
                                activeGlasses = [];

                                setReport(currentReport, currentCase, currentCaseOwner);
                                setReportGlasses(currentAllGlasses, currentReport.attached_glasses, currentCaseOwner)


                                caseLabelNode.style.color = getCaseColor({grossing_status: "CREATED"})
                                document.querySelector('.caseItem.active .caseItemLabel').style.color = getCaseColor({grossing_status: "CREATED"})
                            })
                    }
                })

                reportOwnerInfoNODE.append(div)
            }
        }

        if (!hasOwner && !caseIsClosed) {
            const div = document.createElement('div')
            div.classList = "caseBtnOwner"
            div.innerText = "Забрати кейс"

            div.addEventListener('click', (e) => {
                if(checkToken()){
                    fetch(`${API_BASE_URL}/api/cases/${currentCase.id}/take`, {
                        method: "POST",
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                            "Content-Type": "application/json"
                        },
                    })
                        .then(res => res.json())
                        .then(() => {
                            currentCaseOwner = {
                                doctor_id: "153348TN1-1994M",
                                first_name:"Алексей",
                                id: "009412bd-bc34-4988-8631-9f407f08f41b",
                                last_name: "Жовтенко",
                                middle_name: "Александрович",
                                phone_number: "+380635890210",
                                work_email: "zhowtenko.oleksiy_work@gmail.com",
                                is_case_owner: true,
                            };

                            setReport(currentReport, currentCase, currentCaseOwner);
                            setReportGlasses(currentAllGlasses, currentReport.attached_glasses, currentCaseOwner)

                            caseLabelNode.style.color = getCaseColor({grossing_status: "PROCESSING"})
                            document.querySelector('.caseItem.active .caseItemLabel').style.color = getCaseColor({grossing_status: "PROCESSING"})
                        })
                }
            })

            reportOwnerInfoNODE.append(div)
        }
    }
    const setReport = (currentReport, workCase, caseOwner) => {
        const caseIsClosed = workCase.grossing_status === "COMPLETED";
        reportWrapperNODE.innerHTML = ""

        const isMyCase = caseOwner?.is_case_owner;
        const disabledStyle = "opacity: .4; pointer-events: none"
        const formNODE = document.createElement('form')
        formNODE.setAttribute("id", "reportForm")
        formNODE.style.pointerEvents = caseIsClosed ? "none" : "auto"
        const myReportData = currentReport.doctor_diagnoses.find(({doctor}) => doctor.doctor_id === myCorId)
        const secondThinkReportData = currentReport.doctor_diagnoses.filter(({doctor}) => doctor.doctor_id !== myCorId)
        const caseOwnerReport = currentReport.doctor_diagnoses.find(({doctor}) => doctor.doctor_id === caseOwner?.doctor_id)

        const {immunohistochemicalProfile, molecularGeneticProfile, pathomorphologicalDiagnosis} = secondThinkReportData
            .reduce((secondThinkReportData, reportData) => {
                const {doctor} = reportData;
                if(reportData.immunohistochemical_profile){
                    secondThinkReportData.immunohistochemicalProfile += `
                    <div class="conclusionSecondOpinion">
                        ${getShortName(doctor.last_name, doctor.first_name, doctor.middle_name)}: ${reportData.immunohistochemical_profile}
                    </div>
                    `
                }
                if(reportData.molecular_genetic_profile){
                    secondThinkReportData.molecularGeneticProfile += `
                    <div class="conclusionSecondOpinion">
                        ${getShortName(doctor.last_name, doctor.first_name, doctor.middle_name)}: ${reportData.molecular_genetic_profile}
                    </div>
                    `
                }
                if(reportData.pathomorphological_diagnosis){
                    secondThinkReportData.pathomorphologicalDiagnosis += `
                    <div class="conclusionSecondOpinion">
                        ${getShortName(doctor.last_name, doctor.first_name, doctor.middle_name)}: ${reportData.pathomorphological_diagnosis}
                    </div>
                    `
                }



                return secondThinkReportData;
            }, {
                immunohistochemicalProfile: "",
                molecularGeneticProfile: "",
                pathomorphologicalDiagnosis: "",
            })

        let reportHTmL = `
        <div class="conclusionTop df aic jcsb">
            <div class="conclusionTopLabel">
                ${workCase.case_code}
            </div>
            <div class="conclusionTopDate">
                ${new Date(workCase.creation_date).toLocaleDateString()}
            </div>
        </div>
        <div class="conclusionFormGroup"  style="${!isMyCase ? disabledStyle : ""}">
            <div class="conclusionFormGroupLabel">
                Макроопис
            </div>
            <input type="text" class="conclusionFormGroupInput" name="report_macrodescription" value="${caseOwnerReport?.report_macrodescription || currentReport.concatenated_macro_description || ""}">
        </div>
        <div class="conclusionFormGroup"  style="${!isMyCase ? disabledStyle : ""}">
            <div class="conclusionFormGroupLabel">
                Мікроопис
            </div>
            <input type="text" class="conclusionFormGroupInput" name="report_microdescription" value="${currentReport.microdescription_from_case || ""}">
        </div>
        <div class="conclusionFormGroup">
            <div class="conclusionFormGroupLabel">
                Імуногістохімічний профіль
            </div>
            ${immunohistochemicalProfile}
            <input type="text" name="immunohistochemical_profile" class="conclusionFormGroupInput" value="${myReportData?.immunohistochemical_profile || ""}">
        </div>
        <div class="conclusionFormGroup">
            <div class="conclusionFormGroupLabel">
                Молекулярно-генетичний профіль
            </div>
            ${molecularGeneticProfile}
            <input type="text" name="molecular_genetic_profile" class="conclusionFormGroupInput" value="${myReportData?.molecular_genetic_profile || ""}">
        </div>
        <div class="conclusionFormGroup">
            <div class="conclusionFormGroupLabel">
                Патогістологічний висновок
            </div>
            ${pathomorphologicalDiagnosis}
            <input type="text" name="pathomorphological_diagnosis" class="conclusionFormGroupInput" value="${myReportData?.pathomorphological_diagnosis || ""}">
        </div>
        <div class="conclusionFormGroup" style="${!isMyCase ? disabledStyle : ""}">
            <div class="conclusionFormGroupLabel">
                Код ICD
            </div>
            <input type="text" name="icd_code" class="conclusionFormGroupInput" placeholder="ICD - №: код" value="${caseOwnerReport?.icd_code || ""}">
        </div>
        <div class="conclusionFormGroup" style="${!isMyCase ? disabledStyle : ""}">
            <div class="conclusionFormGroupLabel">
                Коментар
            </div>
            <input type="text" name="comment" class="conclusionFormGroupInput" value="${caseOwnerReport?.comment || ""}">
        </div>
        `

        if(!caseIsClosed){
            reportHTmL += `<div class="conclusionActionBottom" style="margin-bottom: 20px">Оновити репорт</div>`
        }

        formNODE.innerHTML = reportHTmL
        reportWrapperNODE.append(formNODE)

        setOwnerInfo(caseOwner)
        sendReportHandler()
    }
    const setReportGlasses = (currentGlassReport, activeGlassReport, caseOwner) => {
        reportGlassWrapperNODE.innerHTML = "";

        const allGlasses = currentGlassReport.samples.reduce((allGlasses, sample) => {
            const allCassetteGlasses = sample.cassettes.reduce((allCassetteGlasses, cassette) => {
                return [
                    ...allCassetteGlasses,
                    ...cassette.glasses.map((currentGlass) => ({
                        ...currentGlass,
                        cassette_number: cassette.cassette_number
                    }))
                ]
            }, [])

            return [...allGlasses, ...allCassetteGlasses]
        }, [])

        allGlasses.forEach((currentGlass) => {
            reportGlassWrapperNODE.append(glassTemplate(currentGlass, activeGlassReport, caseOwner))
        })

        currentGlasses = allGlasses;
    }
    const setAllCases = () => {
        if(checkToken()){
            const currentRoutePart = PATIENT_COR_ID ? `patients/${PATIENT_COR_ID}` : `current_cases`;
            fetch(`${API_BASE_URL}/api/doctor/${currentRoutePart}/report-page-data?case_id=${INITIAL_CASE_ID || ""}`, {
                method: "GET",
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                },
            })
                .then(res => res.json())
                .then(cases => {
                    const {all_cases, last_case_for_report, report_details, case_owner, all_glasses_for_last_case} = cases;
                    const activeCaseIndex = all_cases.findIndex(({id}) => id === last_case_for_report.id)

                    all_cases.forEach((currentCase, index) => {
                        caseContentNODE.append(caseTemplate(currentCase, activeCaseIndex === index))
                    })

                    currentCase = last_case_for_report;
                    currentReport = report_details;
                    currentCaseOwner = case_owner;
                    currentAllGlasses = all_glasses_for_last_case;
                    activeGlasses = currentReport.attached_glasses
                    currentUserCorId = currentCase.patient_id

                    setReport(currentReport, currentCase, case_owner);
                    setReportGlasses(currentAllGlasses, currentReport.attached_glasses, currentCaseOwner)
                    changeUrlParams()

                    caseLabelNode.innerHTML = currentCase.case_code
                    caseLabelNode.style.color = getCaseColor(currentCase)

                    fetch(`${API_BASE_URL}/api/doctor/patients/${currentCase.patient_id}`, {
                        method: "GET",
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        },
                    })
                        .then(res => res.json())
                        .then(userData => {
                            document.querySelector('#userName').innerHTML = `${userData.surname || ""} ${userData.first_name || ""} ${userData.middle_name || ""}`;
                            document.querySelector('#userGender').innerHTML = userData.sex === "M" ? "Чол" : "Жін";
                            document.querySelector('#userAge').innerHTML = `${(userData.age || "")  ? `${userData.age}р` : ''}`;
                        })
                })
        }
    }

    const caseTemplate = (workCase, isActive) => {
        const caseNewNODE = document.createElement('div');
        caseNewNODE.classList.add('caseItem', 'df', 'aic', 'jcsb', ...(isActive ? ['active'] : []));
        caseNewNODE.innerHTML = `
            <div>
                <div class="caseItemDate">${new Date(workCase.creation_date).toLocaleDateString()}</div>
                <div class="caseItemLabel" style="color: ${getCaseColor(workCase)}">${workCase.case_code}</div>
            </div>
            <div class="caseItemSample df aic jcc">
                ${workCase.bank_count}
            </div>
            <div>
                <div class="infoPlate cassette">
                    ${workCase.cassette_count}
                </div>
            </div>
            <div>
                <div class="infoPlate glass">
                    ${workCase.glass_count}
                </div>
            </div>
        `;

        caseNewNODE.addEventListener("click", () => {
            if(checkToken()){
                fetch(`${API_BASE_URL}/api/doctor/cases/${workCase.id}/report`, {
                    method: "GET",
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                    },
                })
                    .then(res => res.json())
                    .then(caseData => {
                        const {report_details, all_glasses_for_last_case, case_owner, last_case_for_report} = caseData;

                        document.querySelector('.caseItem.active').classList.remove('active')
                        caseNewNODE.classList.add('active')

                        reportGlassWrapperNODE.innerHTML = ""

                        currentCase = last_case_for_report;
                        currentReport = report_details;
                        activeGlasses = report_details.attached_glasses
                        currentUserCorId = last_case_for_report.patient_id

                        setReport(report_details, last_case_for_report, case_owner);
                        setReportGlasses(all_glasses_for_last_case, report_details.attached_glasses)
                        changeUrlParams()

                        caseLabelNode.innerHTML = last_case_for_report.case_code
                        caseLabelNode.style.color = getCaseColor(last_case_for_report)

                        fetch(`${API_BASE_URL}/api/doctor/patients/${last_case_for_report.patient_id}`, {
                            method: "GET",
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                            },
                        })
                            .then(res => res.json())
                            .then(userData => {
                                document.querySelector('#userName').innerHTML = `${userData.surname || ""} ${userData.first_name || ""} ${userData.middle_name || ""}`;
                                document.querySelector('#userGender').innerHTML = userData.sex === "M" ? "Чол" : "Жін";
                                document.querySelector('#userAge').innerHTML = `${(userData.age || "")  ? `${userData.age}р` : ''}`;
                            })
                    })
            }
        });
        return caseNewNODE
    }
    const glassTemplate = (currentGlass, activeGlass, caseOwner) => {
        const fileUrl = currentGlass?.file_url || "/cases/attachments/eb0f5825-f15e-40d2-bd2c-373690995a87"
        const caseIsClosed = currentCase.grossing_status === "COMPLETED";
        const activeGlassIds = activeGlass.map(({id}) => id)
        const glassNewNODE = document.createElement('div');
        glassNewNODE.classList = `glassWrapper ${activeGlassIds.includes(currentGlass.id) ? "active" : ""} ${!fileUrl ? "disabled" : ""}`;

        glassNewNODE.innerHTML = `
            <div class="glassWrapperImg">
            </div>
            <div class="glassWrapperText">
                ${currentGlass.cassette_number} ??L0 H&E???
            </div>
        `;

        getImages(fileUrl)
            .then(blob => {
                if(!blob){
                    return;
                }

                const imgNODE = document.createElement('img');
                imgNODE.src = URL.createObjectURL(blob);
                imgNODE.onload=()=> URL.revokeObjectURL(imgNODE.src);
                glassNewNODE.querySelector('.glassWrapperImg').append(imgNODE);
            })

        if (caseOwner?.is_case_owner && !caseIsClosed) {
            glassNewNODE.addEventListener("click", () => {
                if(glassNewNODE.classList.contains('disabled')){
                    return;
                }

                const isActiveGlass = glassNewNODE.classList.contains('active');
                const actionMethod = isActiveGlass ? "remove" : "add"

                glassNewNODE.classList[actionMethod]('active')

                if (isActiveGlass) {
                    activeGlasses = activeGlasses.filter(glass => glass.id !== currentGlass.id)
                }

                if (!isActiveGlass) {
                    activeGlasses = [...activeGlasses, currentGlass];
                }
            });
        }


        return glassNewNODE
    }

    const sendReportHandler = () => {
        document.querySelector('.conclusionActionBottom')?.addEventListener('click', () => {
            if(checkToken()){
                const formNODE = document.querySelector('#reportForm');
                const formData = Object.fromEntries(new FormData(formNODE).entries());
                const isMyCase = currentCaseOwner?.is_case_owner;

                const requestData = {
                    doctor_diagnosis_data: {
                        ...formData,
                    },
                }

                if(isMyCase){
                    requestData.attached_glass_ids = activeGlasses.map(({id}) => id)
                }


                fetch(`${API_BASE_URL}/api/doctor/cases/${currentCase.id}/report/upsert`, {
                    method: "PUT",
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(requestData)
                })
                    .then(res => res.json())
                    .then(() => {
                        showSuccessAlert('Заключення успішно оновленно')
                    })

            }
        })
    }

    const switchRole = () => {
        document.querySelector('.role-toggle .role-btn:not(.active)').addEventListener('click', (e) => {
            window.location.href = `/static/lab.html?userCorId=${currentUserCorId}`
        })
    }
    const goToTab = () => {
        document.querySelectorAll(".tabs .tab:not(.active)").forEach(elem => {
            elem.addEventListener('click', e => {
                const element = e.currentTarget;
                let queryString = []

                if (PATIENT_COR_ID) {
                    queryString.push(`userCorId=${PATIENT_COR_ID}`)
                }

                if (currentCase?.id) {
                    queryString.push(`caseId=${currentCase?.id}`)
                }


                if (element.classList.contains('directionPage')) {
                    window.location.href = `/static/direction.html?${queryString.join('&')}`
                }
                if (element.classList.contains('tenderloinPage')) {
                    window.location.href = `/static/tenderloin.html?${queryString.join('&')}`
                }
                if (element.classList.contains('glassPage')) {
                    window.location.href = `/static/glass.html?${queryString.join('&')}`
                }
                if (element.classList.contains('conclusionPage')) {
                    window.location.href = `/static/conclusion.html?${queryString.join('&')}`
                }
                if (element.classList.contains('explorationPage')) {
                    window.location.href = `/static/exploration.html?${queryString.join('&')}`
                }
            })
        })
    }
    const revertButtonHandler = () => {
        const revertButtonNODE = document.querySelector('.glassPageRevert');
        if (PATIENT_COR_ID) {
            revertButtonNODE.style.display = "block"
        }

        revertButtonNODE?.addEventListener('click', () => {
            window.location.href = `/static/conclusion.html`
        })
    }

    const goToCasesHandler = () => {
        document.querySelector('#goToCases')?.addEventListener('click', () => {
            window.location.href = `/static/doctor_patients_page.html`
        })
    }
</script>
<script>
    document.addEventListener("DOMContentLoaded", (event) => {
        goToTab()
        switchRole()
        setAllCases()
        revertButtonHandler()
        showTextareaButton('caseMicroDescription')
        showTextareaButton('casePathohistologicalConclusion')
        goToCasesHandler()
    });
</script>

</body>
</html>
