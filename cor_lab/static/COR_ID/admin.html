<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="/static/favicon.png">
       
        <meta name="msapplication-TileColor" content="#ffffff">
        <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
        <meta name="theme-color" content="#ffffff">
        <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="/static/COR_ID_css/styles.css">
    <link rel="stylesheet" type="text/css" href="/static/COR_ID_css/modal.css">
    <link rel="stylesheet" type="text/css" href="/static/COR_ID_css/admin.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>      
    <title>Admin Page</title>
  
</head>
<body>
  <div class="admin-container">
        <button class="link-button" onclick="goBack('/static/COR_ID/mainscreen.html')" data-translate="back-link-text"><<<–Ω–∞–∑–∞–¥<<<</button>
        <h1>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h1>

     <button id="openModalBtn">–í—ã–±—Ä–∞—Ç—å –≤—ã–≤–æ–¥</button>
        <!-- –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        <table id="userTable">
            <thead>
                <tr>
                    <th id="header-user_index">–ò–Ω–¥–µ–∫—Å<br><input type="text" oninput="filterTable()" data-column="user_index"></th>
                    <th id="header-id">ID<br><input type="text" oninput="filterTable()" data-column="id"></th>
                    <th id="header-cor_id">COR-ID<br><input type="text" oninput="filterTable()" data-column="cor_id"></th>
                    <th id="header-user_sex">–ü–æ–ª<br><input type="text" oninput="filterTable()" data-column="user_sex"></th>
                    <th id="header-birth">–ì–æ–¥ —Ä–æ–∂–¥.<br><input type="text" oninput="filterTable()" data-column="birth"></th>
                    <th id="header-email">Email<br><input type="text" oninput="filterTable()" data-column="email"></th>
                    <th id="header-created_at">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏<br><input type="text" oninput="filterTable()" data-column="created_at"></th>
                    <th id="header-last_password_change">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏–∑–º. –ø–∞—Ä–æ–ª—è<br><input type="text" oninput="filterTable()" data-column="last_password_change"></th>
                 <!--   <th id="header-last_active">–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å<br><input type="text" oninput="filterTable()" data-column="last_active"></th> -->
                    <th id="header-last_active">–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å<br>
                      <div class="date-range">
                        <input type="text" id="dateRangeActive" onchange="filterByDateRange()" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç">
                      </div>
                    </th> 
                    <th id="header-account_status">–°—Ç–∞—Ç—É—Å –∞–∫–∫–∞—É–Ω—Ç–∞<br><input type="text" oninput="filterTable()" data-column="account_status"></th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                   
                </tr>
        
            </thead>
            <tbody>
                <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
            </tbody>
        </table>

        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
        <div class="pagination" id="pagination">
            <button onclick="goToFirstPage()" class="pagination button">¬´ –ü–µ—Ä–≤—ã–π</button>
            <button onclick="prevPage()"  class="pagination button">¬´ –ù–∞–∑–∞–¥</button>
            <span id="page-info">–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1</span> <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
            <button onclick="nextPage()" class="pagination button">–í–ø–µ—Ä–µ–¥ ¬ª</button>
            <button onclick="goToLastPage()" class="pagination button">–ü–æ—Å–ª–µ–¥–Ω–∏–π ¬ª¬ª</button>
        </div>
  </div>

            <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫ --> 
            <div id="columnSelectModal" class="modal" style="display: none;">
                <div class="modal-header">
                    <h1>–ü–æ–ª—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</h1>
                    <div class="modal-buttons">
                        <button class="modal-button close" data-action="close" id="closeColumnSelectModal">‚úñ</button>
                    </div>
                </div>
                <div class="checkbox-container">
                    <label><input type="checkbox" onchange="toggleColumn('user_index')" id="checkbox-user_index" checked>–ò–Ω–¥–µ–∫—Å</label>
                    <label><input type="checkbox" onchange="toggleColumn('id')" id="checkbox-id" checked>ID</label>
                    <label><input type="checkbox" onchange="toggleColumn('cor_id')" id="checkbox-cor_id" checked>COR-ID</label>
                    <label><input type="checkbox" onchange="toggleColumn('user_sex')" id="checkbox-user_sex" checked>–ü–æ–ª</label>
                    <label><input type="checkbox" onchange="toggleColumn('birth')" id="checkbox-birth" checked>–ì–æ–¥ —Ä–æ–∂.</label>
                    <label><input type="checkbox" onchange="toggleColumn('email')" id="checkbox-email" checked>Email</label>
                    <label><input type="checkbox" onchange="toggleColumn('created_at')" id="checkbox-created_at" checked>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</label>
                    <label><input type="checkbox" onchange="toggleColumn('last_password_change')" id="checkbox-last_password_change" checked>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è</label>
                    <label><input type="checkbox" onchange="toggleColumn('last_active')" id="checkbox-last_active" checked>–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</label>
                </div>
                <div class="modal-footer" style="text-align: center; margin-top: 20px;">
                    <button onclick="closeModal('columnSelectModal')" class="button">–û–ö</button>
                </div>
            </div>

                
            <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ COR-ID -->
            <div id="corIdModal" class="modal" style="display: none;">
                <div class="modal-header">
                    <h1>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ COR-ID:</h1>
                    <div class="modal-buttons">
                        <button class="modal-button close" data-action="close" id="closeCorIDModal">‚úñ</button>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 30px;">
                    <span id="corIdValue" style="color: #291161; font-size: 17px;"></span>
                </div>       
                    <div id="corIdInfo" class="cor-card"> </div>
                        <!-- –ó–¥–µ—Å—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ COR-ID -->                              
                    <div id="qrcode"></div>
            </div>



            <div id="rolesModal" class="modal" style="display: none;">
                <div class="modal-header">
                    <h3 style="margin-top:30; color:#291161;font-size: 17px;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</h3>
                    <div class="modal-buttons">
                        <button class="modal-button close" data-action="close" id="closeRolesModal">‚úñ</button>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 30px;">
                    <span id="rolesEmail" style="color: #291161; font-size: 15px;"></span>
                </div> 
                <div style="text-align: center; margin-top: 10px;">
                    <span id="roles–°orId" style="color: #291161; font-size: 17px;"></span>
                </div>       
                <div id="rolesList" class="checkbox-container">
                    <!-- –°–ø–∏—Å–æ–∫ —Ä–æ–ª–µ–π –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
                <div class="modal-footer" style="text-align: center; margin-top: 20px;">
                    <button onclick="saveUserRoles()" class="button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
            
            <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º–∏ —Ä–æ–ª–∏ -->
            <div id="roleInfoModal" class="modal" style="display: none;">
                <div class="modal-header">
                    <h3 style="margin-top:30; color:#291161;font-size: 17px;">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Ä–æ–ª–∏:</h3>
                    <div class="modal-buttons">
                        <button class="modal-button close" data-action="close" id="closeRoleInfoModal">‚úñ</button>
                    </div>
                </div>
                <div id="roleInfoContent" style="padding: 0px;">
                    <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–æ–ª–∏ -->
                </div>
               
            </div> 


    <script src="/static/COR_ID_Js/translation.js"></script>
    <script src="/static/COR_ID_Js/general_fun.js"></script>
    <script src="/static/COR_ID_Js/admin.js"></script>
    <script> 

document.addEventListener('DOMContentLoaded', () => {
        initAdminPanel();
        initDateRangePickers();
        document.getElementById('closeRolesModal')?.addEventListener('click', () => closeModal('rolesModal'));
        document.getElementById('closeRoleInfoModal')?.addEventListener('click', () => closeModal('roleInfoModal'));
        document.getElementById('closeColumnSelectModal')?.addEventListener('click', () => closeModal('columnSelectModal'));
        document.getElementById('closeCorIDModal')?.addEventListener('click', () => closeModal('corIdModal'));

                });



                document.addEventListener('DOMContentLoaded', function () {
    const tableBody = document.querySelector("#userTable tbody");
    if (!tableBody) return;

    tableBody.addEventListener('click', function (event) {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –Ω–∞ COR-ID
        if (event.target.tagName === 'TD' && event.target.classList.contains('cor-id-cell')) {
            const corId = event.target.textContent.trim();
            if (corId) showCorIdInfo(corId);
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –Ω–∞ –∏–∫–æ–Ω–∫—É —Ä–æ–ª–µ–π
        if (event.target.classList.contains('roles-icon')) {
            const row = event.target.closest('tr');
            if (row) {
                const corIdCell = row.querySelector('.cor-id-cell');
                if (corIdCell) {
                    const corId = corIdCell.textContent.trim();
                    if (corId) showUserRoles(corId);
                }
            }
        }
    });
});                

        let widthsArray= [20, 70, 70, 10, 30,70,50,50,50,50,30];
        let currentPage = 1;
        let rowsPerPage = 10;
        let totalRows = 0;

        
        let allFilteredUsers = []; // –•—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        let isFiltering = false; // –§–ª–∞–≥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
          

async function getAllUsers(skip = 0, limit = rowsPerPage) {
    const url = `/api/admin/get_all?skip=${skip}&limit=${limit}`;
    console.log('–ó–∞–ø—Ä–æ—Å URL:', url);
    try {
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + getToken()
            }
        });

        console.log('HTTP –∫–æ–¥ –æ—Ç–≤–µ—Ç–∞:', response.status); // –õ–æ–≥–∏—Ä—É–µ–º HTTP —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
        if (response.status==='401') {
        showTokenExpiredModal();
        } 

        if (!response.ok) {
            throw new Error(`–û—à–∏–±–∫–∞: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        console.log('–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', JSON.stringify(data, null, 2));
       
        const users = Array.isArray(data) ? data : []; 

        console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–æ–π—Å—Ç–≤–∞ users:', users);
       

        if (users.length > 0) {
            console.log('–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:', users);
            populateTable(users); 
            adjustTableLayout();
            return users;
        } else {
            console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.');
            return false; 
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);      
        return false;
    }
}
    

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function confirmStatusChange(email, newStatus) {
            const confirmChange = confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å email: ${email} –Ω–∞ ${newStatus}?`);

            if (!confirmChange) return;
            const url = `/api/admin/asign_status/${newStatus}?email=${encodeURIComponent(email)}`;

            try {
                const response = await fetch(url, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + getToken()
                    }
                });

                if (response.ok) {
                    alert(`–°—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${email} —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ ${newStatus}.`);
                    getAllUsers(); // –û–±–Ω–æ–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
                } else {
                    const errorData = await response.json();
                    alert(`–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: ${errorData.message || response.statusText}`);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.');
            }
        }


 // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏—é/–¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 async function toggleUserStatus(email, isActive) {
 

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ URL –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞ isActive
    const url = isActive 
        ? `/api/admin/deactivate/${encodeURIComponent(email)}` 
        : `/api/admin/activate/${encodeURIComponent(email)}`;

    try {
        const response = await fetch(url, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + getToken()
            }
        });
        
        const result = await response.json();

        if (response.ok) {
            alert(result.message);
            getAllUsers(); // –û–±–Ω–æ–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
        } else {
            alert(`–û—à–∏–±–∫–∞: ${result.message}`);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.');
    }
}

async function filterTable() {
    if (isFiltering) {
        console.log("–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –æ—Ç–º–µ–Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞");
        return;
    }
    isFiltering = true;

    // –°–æ–±–∏—Ä–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏–∑ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
    const filters = {};
    document.querySelectorAll('thead input[type="text"]').forEach(input => {
        const column = input.getAttribute('data-column');
        const value = input.value.trim().toLowerCase();
        if (value) {
            filters[column] = value; // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Ñ–∏–ª—å—Ç—Ä—ã —Ç–æ–ª—å–∫–æ –Ω–µ–ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        }
    });

    console.log("–ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:", filters);

    allFilteredUsers = [];
    let skip = 0;
    let hasMoreData = true;

    while (hasMoreData) {
        console.log(`–ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö —Å –ø—Ä–æ–ø—É—Å–∫–æ–º: ${skip}, –ª–∏–º–∏—Ç: ${rowsPerPage}`);
        const users = await getAllUsers(skip, rowsPerPage);

        if (Array.isArray(users) && users.length > 0) {
            console.log(`–ü–æ–ª—É—á–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${users.length}`);
            const filteredUsers = users.filter(user => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
                return Object.keys(filters).every(column => {
                    return user[column]?.toString().toLowerCase().includes(filters[column]);
                });
            });

            console.log(`–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${filteredUsers.length}`);
            allFilteredUsers = allFilteredUsers.concat(filteredUsers);
            skip += rowsPerPage;
        } else {
            hasMoreData = false;
            console.log("–ù–µ—Ç –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö");
        }
    }

    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    populateTable(allFilteredUsers.slice(0, rowsPerPage));
    isFiltering = false;
}
  
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        function updatePageInfo() {
            document.getElementById('page-info').innerText = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage}`;
        }


        // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            async function nextPage() {
                const skip = currentPage * rowsPerPage;
                const dataAvailable = await getAllUsers(skip, rowsPerPage);

                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º currentPage, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã
                if (dataAvailable) {
                    currentPage++;
                    updatePageInfo();
                }
            }

            // –ü–µ—Ä–µ–º–æ—Ç–∫–∞ –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            function prevPage() {
                if (currentPage > 1) {
                    currentPage--;
                    updatePageInfo();
                    const skip = (currentPage - 1) * rowsPerPage;
                    getAllUsers(skip, rowsPerPage); // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                }
            }


        function goToFirstPage() {
            currentPage = 1;
            updatePageInfo();
            loadPage();
        }

        async function goToLastPage() {
            let totalUsers = 0; // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ
            let skip = 0;
            let hasMoreData = true;

            while (hasMoreData) {
                console.log(`–ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö —Å –ø—Ä–æ–ø—É—Å–∫–æ–º: ${skip}, –ª–∏–º–∏—Ç: ${rowsPerPage}`);
                const users = await getAllUsers(skip, rowsPerPage); // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

                if (Array.isArray(users) && users.length > 0) {
                    totalUsers += users.length; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    skip += rowsPerPage; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø—Ä–æ–ø—É—Å–∫ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
                } else {
                    hasMoreData = false; // –ü—Ä–µ–∫—Ä–∞—â–∞–µ–º —Ü–∏–∫–ª, –µ—Å–ª–∏ –Ω–µ—Ç –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö
                    console.log("–ù–µ—Ç –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö");
                }
            }

            // –í—ã—á–∏—Å–ª—è–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü
            const totalPages = Math.ceil(totalUsers / rowsPerPage);
            currentPage = totalPages; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é

            updatePageInfo(); // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            loadPage(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        }

        function loadPage() {
            const skip = (currentPage - 1) * rowsPerPage;
            getAllUsers(skip, rowsPerPage);
        }

                // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∏ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            function openModal() {
                document.getElementById("corIdModal").style.display = "block";
                
            }

            document.addEventListener('DOMContentLoaded', function () {
                const tableBody = document.querySelector("#userTable tbody");
                if (!tableBody) return;

                tableBody.addEventListener('click', function (event) {
                    // –ë–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –∫–ª–∏–∫ –∏–º–µ–Ω–Ω–æ –Ω–∞ TD —Å –∫–ª–∞—Å—Å–æ–º cor-id-cell
                    if (event.target.tagName === 'TD' && event.target.classList.contains('cor-id-cell')) {
                        const corId = event.target.textContent.trim();
                        if (corId) showCorIdInfo(corId);
                    }
                });
            });

        
 
           
                    
           // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∫–æ–ª–æ–Ω–æ–∫ –∏–∑ localStorage
            function initializeColumns() {
                const columnState = JSON.parse(localStorage.getItem('columnsState') || '{}');

                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–ª–æ–Ω–∫–∏
                Object.keys(columnState).forEach(column => {
                    const header = document.getElementById(`header-${column}`);
                    if (header) {
                        const isVisible = columnState[column];
                        header.style.display = isVisible ? '' : 'none'; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å

                        // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —è—á–µ–µ–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ
                        const cells = document.querySelectorAll(`tbody td:nth-child(${Array.from(header.parentNode.children).indexOf(header) + 1})`);
                        cells.forEach(cell => {
                            cell.style.display = header.style.display;
                        });
                    }
                });
            }

  
            function adjustContainerWidth() {
    const table = document.querySelector('#userTable');
    const container = document.querySelector('.admin-container');
    if (!table || !container) return;

    // –í—Ä–µ–º–µ–Ω–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º layout
    table.style.tableLayout = 'auto';
    table.style.width = 'auto';

    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —à–∏—Ä–∏–Ω—É —Ç–∞–±–ª–∏—Ü—ã
    const actualWidth = table.scrollWidth;

    // –ü—Ä–∏–º–µ–Ω—è–µ–º —à–∏—Ä–∏–Ω—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É
    container.style.width = `${actualWidth}px`;
    container.style.minWidth = '400px';
    container.style.maxWidth = '95vw';

    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π layout
    table.style.tableLayout = 'fixed';
    table.style.width = '100%';

    console.log('container width adjusted to:', container.style.width);
}

function setAllColumnWidths(widthsArray) {
    const table = document.querySelector('#userTable');
    if (!table || !widthsArray || !widthsArray.length) return;

    // –í—Ä–µ–º–µ–Ω–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ auto layout –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞
    table.style.tableLayout = 'auto';
    
    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
    const allHeaders = table.querySelectorAll('thead th');
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —à–∏—Ä–∏–Ω—ã
    widthsArray.forEach((width, index) => {
        if (index >= allHeaders.length) return;
        
        const header = allHeaders[index];
        const cells = table.querySelectorAll(`tbody td:nth-child(${index + 1})`);
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–æ–ª–æ–Ω–∫–∞ –≤–∏–¥–∏–º–∞
        if (header.style.display !== 'none') {
            header.style.width = `${width}px`;
            header.style.minWidth = `${width}px`;
            cells.forEach(cell => {
                cell.style.width = `${width}px`;
                cell.style.minWidth = `${width}px`;
            });
        } else {
            // –î–ª—è —Å–∫—Ä—ã—Ç—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —à–∏—Ä–∏–Ω—É
            header.style.width = '';
            header.style.minWidth = '';
            cells.forEach(cell => {
                cell.style.width = '';
                cell.style.minWidth = '';
            });
        }
    });

    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π layout –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —à–∏—Ä–∏–Ω
    table.style.tableLayout = 'fixed';
    console.log("–®–∏—Ä–∏–Ω—ã –∫–æ–ª–æ–Ω–æ–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã");
}


           
function initAdminPanel() {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
  checkToken();
  console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ó–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...');
  initializeColumns();
  initializeCheckboxes();
  adjustTableLayout();
  makeModalDraggable('columnSelectModal');
  makeModalDraggable('corIdModal');
  makeModalDraggable('rolesModal');
  makeModalDraggable('roleInfoModal');
  setupEventListeners();
  getAllUsers();
}

function initDateRangePickers() {
  const dateInputs = document.querySelectorAll('input[id*="Range"]');
  
  dateInputs.forEach(input => {
    input.addEventListener('focus', () => initFlatpickr(input));
  });
}


function initFlatpickr(inputElement) {
  new flatpickr(inputElement, {
    mode: "range", 
    dateFormat: "Y-m-d",
    onClose: function(selectedDates) {
      if (selectedDates.length === 2) {
        inputElement.value = formatDateRange(selectedDates[0], selectedDates[1]);
      }
    }
  });
}

function formatDateRange(startDate, endDate) {
  return `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`;
}

function setupEventListeners() {
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
  window.addEventListener('resize', adjustTableLayout());
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
  document.getElementById('openModalBtn').addEventListener('click', () => {
    initializeCheckboxes();
    document.getElementById('columnSelectModal').style.display = 'block';
  });
}

function adjustTableLayout() {
    
    setAllColumnWidths(widthsArray);
   // adjustContainerWidth();
}



async function showUserRoles(corId) {
    if (!checkToken()) return;
    try {
        const response = await fetch(`/api/admin/get_user_info/${corId}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + getToken()
            }
        });

        if (!response.ok) {
            throw new Error(`–û—à–∏–±–∫–∞: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        const userInfo = data.user_info;
        const userRoles = data.user_roles || [];
        console.log("–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", data);

        // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        document.getElementById("rolesEmail").textContent = userInfo.email;
        document.getElementById("roles–°orId").textContent = userInfo.cor_id;

        const rolesList = document.getElementById("rolesList");
        rolesList.innerHTML = '';

        // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–æ–ª–µ–π
        const allRoles = ['admin', 'lawyer', 'cor-int', 'active_user', 'doctor','energy_manager', 'lab_assistant'];
        allRoles.forEach(role => {
            const isChecked = userRoles.includes(role);
            
            // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–æ–ª–∏
            const roleContainer = document.createElement('div');
            roleContainer.className = 'role-container';
            
            // –°–æ–∑–¥–∞–µ–º "—á–µ–∫–±–æ–∫—Å" (–Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –ø—Ä–æ—Å—Ç–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞)
            const checkboxIcon = document.createElement('span');
            checkboxIcon.className = 'role-checkbox-icon';
            checkboxIcon.innerHTML = isChecked ? '‚úì' : '‚úó';
            checkboxIcon.style.color = isChecked ? 'green' : 'red';
            
            // –°–æ–∑–¥–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–æ–ª–∏
            const roleName = document.createElement('span');
            roleName.className = 'role-name';
            roleName.textContent = role;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Ä–æ–ª–∏
            roleName.addEventListener('click', (e) => {
                e.preventDefault();
                // –ü–µ—Ä–µ–¥–∞–µ–º —Ç–æ–ª—å–∫–æ cor_id –≤–º–µ—Å—Ç–æ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
                showRoleInfo(role, userInfo.cor_id); 
            });
                        
            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –≤–º–µ—Å—Ç–µ
            roleContainer.appendChild(checkboxIcon);
            roleContainer.appendChild(roleName);
            rolesList.appendChild(roleContainer);
        });

        const saveButton = document.querySelector('#rolesModal .modal-footer button');
        if (saveButton) {
            saveButton.style.display = 'none';
        }

        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        document.getElementById("rolesModal").style.display = "block";

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ');
    }
}


// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–≤–æ–¥–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–æ–ª–∏
function showRoleInfo(role, corId) {
    const roleInfoContent = document.getElementById("roleInfoContent");
    roleInfoContent.innerHTML = '';
    
    // –í—ã–±–∏—Ä–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Ä–æ–ª–∏
    const roleHandlers = {
        'admin': showAdminInfo,
        'lawyer': showLawyerInfo,
        'cor-int': showCorIntInfo,
        'active_user': showActiveUserInfo,
        'doctor': showDoctorInfo,
        'energy_manager': showEnergyManagerInfo,
        'lab_assistant': showLabAssistantInfo
    };
    
    if (roleHandlers[role]) {
        roleHandlers[role](corId); // –¢–µ–ø–µ—Ä—å –ø–µ—Ä–µ–¥–∞–µ–º —Ç–æ–ª—å–∫–æ corId
    } else {
        roleInfoContent.innerHTML = `<p>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–æ–ª–∏ "${role}" –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.</p>`;
    }
    
    document.getElementById("roleInfoModal").style.display = "block";
}

function showAdminInfo(userData) {
    const roleInfoContent = document.getElementById("roleInfoContent");
    roleInfoContent.innerHTML = `
        <h3>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</h3>
        <div class="role-form">
            <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –ø–æ–ª–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞</p>
        </div>
    `;
}

function showLawyerInfo(userData) {
    const roleInfoContent = document.getElementById("roleInfoContent");
    roleInfoContent.innerHTML = `
        <h3>–Æ—Ä–∏—Å—Ç</h3>
        <div class="role-form">
            <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –ø–æ–ª–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞</p>
        </div>
    `;
}

function showCorIntInfo(userData) {
    const roleInfoContent = document.getElementById("roleInfoContent");
    roleInfoContent.innerHTML = `
        <h3>–Æ—Ä–∏—Å—Ç</h3>
        <div class="role-form">
            <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –ø–æ–ª–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞</p>
        </div>
    `;
}

function showActiveUserInfo(userData) {
    const roleInfoContent = document.getElementById("roleInfoContent");
    roleInfoContent.innerHTML = `
        <h3>–Æ—Ä–∏—Å—Ç</h3>
        <div class="role-form">
            <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –ø–æ–ª–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞</p>
        </div>
    `;
}

function showEnergyManagerInfo(userData) {
    const roleInfoContent = document.getElementById("roleInfoContent");
    roleInfoContent.innerHTML = `
        <h3>–Æ—Ä–∏—Å—Ç</h3>
        <div class="role-form">
            <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –ø–æ–ª–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞</p>
        </div>
    `;
}


function showLabAssistantInfo(userData) {
    const roleInfoContent = document.getElementById("roleInfoContent");
    roleInfoContent.innerHTML = `
        <h3>–Æ—Ä–∏—Å—Ç</h3>
        <div class="role-form">
            <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –ø–æ–ª–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞</p>
        </div>
    `;
}
async function showDoctorInfo(corId) {
    const roleInfoContent = document.getElementById("roleInfoContent");
    
    try {
        console.log('[DoctorInfo] –ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤—Ä–∞—á–∞ –¥–ª—è corId:', corId);
        
        if (typeof corId !== 'string') {
            const errorMsg = `–û–∂–∏–¥–∞–ª—Å—è string corId, –ø–æ–ª—É—á–µ–Ω–æ: ${typeof corId}`;
            console.error('[DoctorInfo] –û—à–∏–±–∫–∞:', errorMsg, corId);
            throw new Error(errorMsg);
        }

        roleInfoContent.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤—Ä–∞—á–∞...</p>';
        
        const response = await fetch(`/api/admin/get_user_info/${corId}/doctors-data`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Authorization': 'Bearer ' + getToken()
            }
        });

        if (!response.ok) {
            throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        const doctorInfo = data.doctor_info || {};
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ roleInfoModal
        roleInfoContent.innerHTML = `
    <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—Ä–∞—á–µ</h3>
    <div class="doctor-tabs">
        <div class="tabs-header">
            <button class="tab-btn active" data-tab="personal">–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</button>
            <button class="tab-btn" data-tab="documents">–î–æ–∫—É–º–µ–Ω—Ç—ã</button>
            <button class="tab-btn" data-tab="diplomas">–î–∏–ø–ª–æ–º—ã</button>
            <button class="tab-btn" data-tab="certificates">–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã</button>
            <button class="tab-btn" data-tab="clinics">–ö–ª–∏–Ω–∏–∫–∏</button>
        </div>     
            <div id="personal-tab" class="tab-pane">
                ${renderPersonalInfo(doctorInfo)}
            </div>
            <div id="documents-tab" class="tab-pane">
                ${renderDocuments(doctorInfo)}
            </div>
            <div id="diplomas-tab" class="tab-pane">
                ${renderDiplomas(doctorInfo.diplomas || [])}
            </div>
            <div id="certificates-tab" class="tab-pane">
                ${renderCertificates(doctorInfo.certificates || [])}
            </div>
            <div id="clinics-tab" class="tab-pane">
                ${renderClinics(doctorInfo.clinic_affiliations || [])}
            </div>       
    </div>
    <button id="saveDoctorButton" class="button" style=" bottom:10px; margin:-10px 120px; margin-top:20px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Ä–∞—á–∞</button>
`;


initTabs();
 document.getElementById("saveDoctorButton")?.addEventListener("click", () => {saveDoctorData(corId); });

    } catch (error) {
        console.error('[DoctorInfo] –û—à–∏–±–∫–∞:', error);
        roleInfoContent.innerHTML = `<p class="error">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Ä–∞—á–µ: ${error.message}</p>`;
    }
    
    // –ù–µ –Ω—É–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å showModal, —Ç–∞–∫ –∫–∞–∫ roleInfoModal —É–∂–µ –æ—Ç–∫—Ä—ã—Ç
}
// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Ä–∞–∑–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–æ–≤
function renderPersonalInfo(doctor) {
    return `
        <div class="form-group-width">
            <label>–ò–º—è:</label>
            <input type="text" id="doctorFirstName" value="${doctor.first_name || ''}">
        </div>
        <div class="form-group-width">
            <label>–§–∞–º–∏–ª–∏—è:</label>
            <input type="text" id="doctorLastName" value="${doctor.last_name || ''}">
        </div>
        <div class="form-group-width">
            <label>–û—Ç—á–µ—Å—Ç–≤–æ:</label>
            <input type="text" id="doctorMiddleName" value="${doctor.middle_name || ''}">
        </div>
        <div class="form-group-width">
            <label>–†–∞–±–æ—á–∏–π email:</label>
            <input type="email" id="doctorWorkEmail" value="${doctor.work_email || ''}">
        </div>
        <div class="form-group-width">
            <label>–¢–µ–ª–µ—Ñ–æ–Ω:</label>
            <input type="tel" id="doctorPhone" value="${doctor.phone_number || ''}">
        </div>
      
    `;
}

function renderDocuments(doctor) {
    return `

        <div class="form-group-width">
            <label>–ü–∞—Å–ø–æ—Ä—Ç:</label>
            <input type="text" id="doctorPassportCode" value="${doctor.passport_code || ''}">
        </div>
        <div class="form-group-width">
            <label>–ú–µ—Å—Ç–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</label>
            <input type="text" id="doctorRegistration" value="${doctor.place_of_registration || ''}">
        </div>
        <div class="form-group-width">
            <label>–ò–ù–ù:</label>
            <input type="text" id="doctorInn" value="${doctor.taxpayer_identification_number || ''}">
        </div>
        <div class="form-group-width">
            <label>–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–∏:</label>
            <input type="date" id="doctorAttestationDate" value="${doctor.date_of_last_attestation || ''}">
        </div>
        <div class="form-group-width">
            <label>–ù–∞—É—á–Ω–∞—è —Å—Ç–µ–ø–µ–Ω—å:</label>
            <input type="text" id="doctorDegree" value="${doctor.scientific_degree || ''}">
        </div>
    `;
}

function renderDiplomas(diplomas) {
    const list = diplomas.length > 0 ? diplomas : [{}];  // —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø—É—Å—Ç–æ–π

    return `
        <div class="documents-list">
            ${list.map((diploma, index) => `
                <div data-id="${diploma.id || ''}">
                    <h4>–î–∏–ø–ª–æ–º</h4>
                    <div class="form-group-width">
                        <label>–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç:</label>
                        <input type="text" value="${diploma.university || ''}">
                    </div>
                    <div class="form-group-width">
                        <label>–°–µ—Ä–∏—è:</label>
                        <input type="text" value="${diploma.series || ''}">
                    </div>
                    <div class="form-group-width">
                        <label>–ù–æ–º–µ—Ä:</label>
                        <input type="text" value="${diploma.number || ''}">
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}


function renderCertificates(certificates) {
    const list = certificates.length > 0 ? certificates : [{}];

    return `
        <div class="documents-list">
            ${list.map((cert, index) => `
                <div data-id="${cert.id || ''}">
                    <h4>–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç</h4>
                    <div class="form-group-width">
                        <label>–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç:</label>
                        <input type="text" value="${cert.university || ''}">
                    </div>
                    <div class="form-group-width">
                        <label>–°–µ—Ä–∏—è:</label>
                        <input type="text" value="${cert.series || ''}">
                    </div>
                    <div class="form-group-width">
                        <label>–ù–æ–º–µ—Ä:</label>
                        <input type="text" value="${cert.number || ''}">
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

function renderClinics(clinics) {
    const list = clinics.length > 0 ? clinics : [{}];

    return `
        <div class="clinics-list">
            ${list.map((clinic, index) => `
                <div data-id="${clinic.id || ''}">
                    <h4>–ö–ª–∏–Ω–∏–∫–∞</h4>
                    <div class="form-group-width">
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                        <input type="text" value="${clinic.clinic_name || ''}">
                    </div>
                    <div class="form-group-width">
                        <label>–û—Ç–¥–µ–ª–µ–Ω–∏–µ:</label>
                        <input type="text" value="${clinic.department || ''}">
                    </div>
                    <div class="form-group-width">
                        <label>–î–æ–ª–∂–Ω–æ—Å—Ç—å:</label>
                        <input type="text" value="${clinic.position || ''}">
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function showModal(modalId, content) {
    const modal = document.getElementById(modalId);
    if (!modal) {
        const newModal = document.createElement('div');
        newModal.id = modalId;
        newModal.className = 'modal';
        document.body.appendChild(newModal);
    }
    
    document.getElementById(modalId).innerHTML = content;
    document.getElementById(modalId).style.display = 'block';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function initTabs() {
    const tabsContainer = document.querySelector('.doctor-tabs');
    if (!tabsContainer) return;

    // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–≤—É—é –≤–∫–ª–∞–¥–∫—É –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—É—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    const firstTab = tabsContainer.querySelector('.tab-btn');
    const firstPane = tabsContainer.querySelector('.tab-pane');
    if (firstTab && firstPane) {
        firstTab.classList.add('active');
        firstPane.classList.add('active');
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤
    tabsContainer.addEventListener('click', function(e) {
        const btn = e.target.closest('.tab-btn');
        if (!btn) return;

        // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –∏ –ø–∞–Ω–µ–ª–µ–π
        tabsContainer.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        tabsContainer.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Ç–µ–∫—É—â–µ–π –∫–Ω–æ–ø–∫–µ –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –ø–∞–Ω–µ–ª–∏
        btn.classList.add('active');
        const tabId = btn.getAttribute('data-tab');
        const pane = tabsContainer.querySelector(`#${tabId}-tab`);
        if (pane) pane.classList.add('active');
    });
}



async function saveDoctorData(corId) {
    try {
        console.log("üì§ –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤—Ä–∞—á–∞...");

        const data = {
            first_name: document.getElementById("doctorFirstName").value.trim(),
            last_name: document.getElementById("doctorLastName").value.trim(),
            middle_name: document.getElementById("doctorMiddleName").value.trim(),
            work_email: document.getElementById("doctorWorkEmail").value.trim(),
            phone_number: document.getElementById("doctorPhone").value.trim(),
            scientific_degree: document.getElementById("doctorDegree").value.trim(),
            passport_code: document.getElementById("doctorPassportCode").value.trim(),
            place_of_registration: document.getElementById("doctorRegistration").value.trim(),
            taxpayer_identification_number: document.getElementById("doctorInn").value.trim(),
            date_of_last_attestation: document.getElementById("doctorAttestationDate").value || new Date().toISOString().split('T')[0],
            diplomas: [],
            certificates: [],
            clinic_affiliations: []
        };

        console.log("‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:", data);

        // –î–∏–ø–ª–æ–º—ã
        document.querySelectorAll('#diplomas-tab div[data-id]').forEach((d, idx) => {
            const inputs = d.querySelectorAll('input');
            const diploma = {
                university: inputs[0]?.value.trim() || "",
                series: inputs[1]?.value.trim() || "",
                number: inputs[2]?.value.trim() || "",
                date: "2023-01-01"
            };
            console.log(`üìò –î–∏–ø–ª–æ–º #${idx + 1}:`, diploma);
            data.diplomas.push(diploma);
        });

        // –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
        document.querySelectorAll('#certificates-tab div[data-id]').forEach((c, idx) => {
            const inputs = c.querySelectorAll('input');
            const cert = {
                university: inputs[0]?.value.trim() || "",
                series: inputs[1]?.value.trim() || "",
                number: inputs[2]?.value.trim() || "",
                date: "2023-01-01"
            };
            console.log(`üìÑ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç #${idx + 1}:`, cert);
            data.certificates.push(cert);
        });

        // –ö–ª–∏–Ω–∏–∫–∏
        document.querySelectorAll('#clinics-tab div[data-id]').forEach((cl, idx) => {
            const inputs = cl.querySelectorAll('input');
            const clinic = {
                clinic_name: inputs[0]?.value.trim() || "",
                department: inputs[1]?.value.trim() || "",
                position: inputs[2]?.value.trim() || "",
                specialty: "–¢–µ—Ä–∞–ø–µ–≤—Ç"
            };
            console.log(`üè• –ö–ª–∏–Ω–∏–∫–∞ #${idx + 1}:`, clinic);
            data.clinic_affiliations.push(clinic);
        });

        console.log("üì¶ –ü–æ–ª–Ω—ã–π payload –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏:", data);

        const response = await fetch(`/api/admin/signup_as_doctor?user_cor_id=${encodeURIComponent(corId)}`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${getToken()}`
            },
            body: JSON.stringify(data)
        });

        if (!response.ok) {
            const errorText = await response.text();
            console.error(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (${response.status}):`, errorText);
            throw new Error(`–û—à–∏–±–∫–∞: ${response.status} ${response.statusText}\n${errorText}`);
        }

        const result = await response.json();
        console.log("‚úÖ –í—Ä–∞—á —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω:", result);
        alert("‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –Ω–∞–¥–µ–ª—ë–Ω –ø—Ä–∞–≤–∞–º–∏ –≤—Ä–∞—á–∞!");

    } catch (error) {
        console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤—Ä–∞—á–∞:", error);
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: " + error.message);
    }
}

    </script>
</body>
</html>

