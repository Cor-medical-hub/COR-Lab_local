<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="./css/reset.css">
    <link rel="stylesheet" href="./css/infoPlate.css">
    <link rel="stylesheet" href="./css/general.css">
    <link rel="stylesheet" href="./css/comments.css">
    <link rel="stylesheet" href="./css/lab.css">
    <link rel="stylesheet" href="./css/modal.css">
    <link rel="stylesheet" href="./css/caseSettings.css">
    <link rel="stylesheet" href="./css/header.css">
    <link rel="stylesheet" href="./css/directionModal.css">
    <link rel="stylesheet" href="./COR_ID_css/modal.css">
    <title>Document</title>
</head>
<body>

<div class="wrapper">
    <div class="pathomorphology df">
        <div class="caseWrapper">
            <div class="casePlaceholder placeholder">
                <div class="df aic jcsb">
                    <div class="df aic counter notNegative">
                        <svg class="counterAction" width="24" height="24" viewBox="0 0 24 24" fill="none"
                             xmlns="http://www.w3.org/2000/svg" style="display: none;">
                            <path d="M7.01695 13C6.4553 13 6 12.5523 6 12C6 11.4477 6.4553 11 7.01695 11L16.9831 11C17.5447 11 18 11.4477 18 12C18 12.5523 17.5447 13 16.9831 13L7.01695 13Z"
                                  fill="#7527B2"/>
                        </svg>
                        <input id="countOfCase" type="number" value="1" class="counterInput"
                               style="color: #ED1064">
                        <svg class="counterAction" width="24" height="24" viewBox="0 0 24 24" fill="none"
                             xmlns="http://www.w3.org/2000/svg">
                            <path d="M7.01695 13C6.4553 13 6 12.5523 6 12C6 11.4477 6.4553 11 7.01695 11L16.9831 11C17.5447 11 18 11.4477 18 12C18 12.5523 17.5447 13 16.9831 13L7.01695 13Z"
                                  fill="#7527B2"/>
                            <path d="M13 16.9831C13 17.5447 12.5523 18 12 18C11.4477 18 11 17.5447 11 16.9831L11 7.01695C11 6.4553 11.4477 6 12 6C12.5523 6 13 6.4553 13 7.01695V16.9831Z"
                                  fill="#7527B2"/>
                        </svg>

                    </div>
                    <div data-help-text="Додати дослідження" data-help-text-delete="Видалити дослідження" id="createCase" class="actionButton create df aic jcc" style="background: #05B96D">
                        <img src="./assets/plusCircle.svg" alt="plusCircle">
                    </div>
                </div>
                <div id="parentMark" class="parentMark df aic gap4">
                    <div data-value="Standard" data-help-text="Терміновості дослідження: Стандартний" class="casePlate active">S</div>
                    <div data-value="Urgent" data-help-text="Терміновості дослідження: Терміново" class="casePlate">U</div>
                    <div data-value="Frozen" data-help-text="Терміновості дослідження: Заморожений" class="casePlate">F</div>
                </div>
                <div class="divider"></div>
                <div id="childMark" class="childMark">
                    <div class="df aic gap4">
                        <div data-value="Resectio" data-help-text="Тип дослідження: Резекція" class="casePlate active">R</div>
                        <div data-value="Biopsy" data-help-text="Тип дослідження: Біопсія" class="casePlate">B</div>
                        <div data-value="Excisio" data-help-text="Тип дослідження: Висічення" class="casePlate">E</div>
                        <div data-value="Cytology" data-help-text="Тип дослідження: Цитологія" class="casePlate">C</div>
                    </div>
                    <div class="df aic gap4">
                        <div data-value="Cellblock" data-help-text="Тип дослідження: Клітинний блок" class="casePlate">X</div>
                        <div data-value="Second Opinion" data-help-text="Тип дослідження: Друга думка" class="casePlate">S</div>
                        <div data-value="Autopsy" data-help-text="Тип дослідження: Аутопсія" class="casePlate">A</div>
                        <div data-value="Electron Microscopy" data-help-text="Тип дослідження: Електронна мікроскопія" class="casePlate">Y</div>
                    </div>
                </div>
            </div>
            <div id="caseItems" class="caseItems df fdc aic"></div>
            <div class="arrows" id="caseItemsScroll" style="border-left: none; border-bottom: none; border-bottom-left-radius: 20px">
                <div class="prev">
                    <img src="assets/arrow.svg" alt="arrow">
                </div>
                <div class="next">
                    <img src="assets/arrow.svg" alt="arrow">
                </div>
            </div>
        </div>
        <div class="specimenWrapper">
            <div class="specimenPlaceholder placeholder">
                <div class="df aic gap4 fdc">
                    <div class="df aic counter">
                        <svg class="counterAction" width="24" height="24" viewBox="0 0 24 24" fill="none"
                             xmlns="http://www.w3.org/2000/svg">
                            <path d="M7.01695 13C6.4553 13 6 12.5523 6 12C6 11.4477 6.4553 11 7.01695 11L16.9831 11C17.5447 11 18 11.4477 18 12C18 12.5523 17.5447 13 16.9831 13L7.01695 13Z"
                                  fill="#7527B2"/>
                        </svg>

                        <input id="countOfSpecimen" type="number" value="1" class="counterInput"
                               style="color: #ED1064">
                        <svg class="counterAction" width="24" height="24" viewBox="0 0 24 24" fill="none"
                             xmlns="http://www.w3.org/2000/svg">
                            <path d="M7.01695 13C6.4553 13 6 12.5523 6 12C6 11.4477 6.4553 11 7.01695 11L16.9831 11C17.5447 11 18 11.4477 18 12C18 12.5523 17.5447 13 16.9831 13L7.01695 13Z"
                                  fill="#7527B2"/>
                            <path d="M13 16.9831C13 17.5447 12.5523 18 12 18C11.4477 18 11 17.5447 11 16.9831L11 7.01695C11 6.4553 11.4477 6 12 6C12.5523 6 13 6.4553 13 7.01695V16.9831Z"
                                  fill="#7527B2"/>
                        </svg>

                    </div>
                    <div id="createSpecimen"
                         data-help-text="Додати зразок"
                         data-help-text-delete="Видалити зразок"
                         class="actionButton create df aic jcc"
                         style="margin-top: 8px; background: #ED1064">
                        <img src="./assets/plusCircle.svg" alt="plusCircle">
                    </div>
                </div>
            </div>

            <div id="specimenItems" class="specimenItems df fdc aic">

            </div>

            <div class="arrows" id="specimenItemsScroll" style="border-right: none; border-left: none; border-bottom: none">
                <div class="prev">
                    <img src="assets/arrow.svg" alt="arrow">
                </div>
                <div class="next">
                    <img src="assets/arrow.svg" alt="arrow">
                </div>
            </div>
        </div>
        <div class="content df fdc">
            <div class="lab-header-wrapper">
                <div class="header-container empty">
                    <div class="header-row top">
                        <div class="search-container">
                            <input type="text" placeholder="Search">
                            <svg class="search-icon" width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M11.2 5.60001C8.10722 5.60001 5.60001 8.10722 5.60001 11.2C5.60001 14.2928 8.10722 16.8001 11.2 16.8001C12.7087 16.8001 14.0781 16.2035 15.085 15.2333C15.1061 15.2058 15.1292 15.1794 15.1544 15.1543C15.1795 15.1291 15.2059 15.106 15.2334 15.0849C16.2035 14.078 16.8 12.7087 16.8 11.2C16.8 8.10722 14.2928 5.60001 11.2 5.60001ZM16.8256 15.6942C17.8109 14.4624 18.4001 12.9 18.4001 11.2C18.4001 7.22357 15.1765 4 11.2 4C7.22356 4 4 7.22357 4 11.2C4 15.1765 7.22356 18.4001 11.2 18.4001C12.9001 18.4001 14.4625 17.8109 15.6942 16.8255L18.6344 19.7657C18.9468 20.0781 19.4533 20.0781 19.7658 19.7657C20.0782 19.4533 20.0782 18.9467 19.7658 18.6343L16.8256 15.6942Z" fill="#B1A1DA"/>
                            </svg>
                        </div>
                        <div class="role-container">
                            <button class="role-icon" id="goToCases" aria-label="User roles">
                                <svg class="icon-group" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M14.2666 11.1279C16.1699 11.128 17.7128 12.6709 17.7129 14.5742V20.4512C17.7127 20.8636 17.3783 21.1982 16.9658 21.1982H7.03418C6.62172 21.1982 6.28734 20.8636 6.28711 20.4512V14.5742C6.28721 12.6709 7.83002 11.1279 9.7334 11.1279H14.2666ZM5.53516 13.1729C5.38681 13.6154 5.28731 14.0804 5.28711 14.5723H3.44629C2.31795 14.5724 1.40039 15.4908 1.40039 16.6191V19.7979H5.28711V20.4502C5.28711 20.7184 5.35253 20.97 5.46094 21.1973H0.74707C0.334473 21.1973 0 20.8628 0 20.4502V16.6191C0 14.7158 1.54293 13.173 3.44629 13.1729H5.53516ZM20.5537 13.1729C22.457 13.173 24 14.7158 24 16.6191V20.4502C24 20.8628 23.6655 21.1972 23.2529 21.1973H18.5391C18.6475 20.97 18.7129 20.7183 18.7129 20.4502V19.7979H22.5996V16.6191C22.5996 15.4908 21.682 14.5724 20.5537 14.5723H18.7129C18.7127 14.0804 18.6132 13.6154 18.4648 13.1729H20.5537ZM9.7334 12.5283C8.60504 12.5283 7.68662 13.4459 7.68652 14.5742V19.7979H16.3125V14.5742C16.3124 13.4459 15.3949 12.5284 14.2666 12.5283H9.7334ZM4.55273 6.53711C6.13959 6.53711 7.42568 7.82339 7.42578 9.41016C7.42578 10.9971 6.13965 12.2832 4.55273 12.2832C2.96597 12.2831 1.67969 10.997 1.67969 9.41016C1.67979 7.82345 2.96603 6.53721 4.55273 6.53711ZM19.4473 6.53711C21.0339 6.53724 22.3202 7.82347 22.3203 9.41016C22.3203 10.997 21.034 12.2831 19.4473 12.2832C17.8604 12.2832 16.5742 10.9971 16.5742 9.41016C16.5743 7.82339 17.8605 6.53711 19.4473 6.53711ZM4.55273 7.9375C3.74056 7.9376 3.08018 8.59798 3.08008 9.41016C3.08008 10.2225 3.7405 10.8837 4.55273 10.8838C5.36511 10.8838 6.02637 10.2225 6.02637 9.41016C6.02627 8.59792 5.36505 7.9375 4.55273 7.9375ZM19.4473 7.9375C18.6349 7.9375 17.9737 8.59792 17.9736 9.41016C17.9736 10.2225 18.6349 10.8838 19.4473 10.8838C20.2595 10.8837 20.9199 10.2225 20.9199 9.41016C20.9198 8.598 20.2594 7.93763 19.4473 7.9375ZM12 2.80273C13.991 2.80283 15.6053 4.41628 15.6055 6.40723C15.6055 8.39832 13.9911 10.0126 12 10.0127C10.0089 10.0127 8.39453 8.39838 8.39453 6.40723C8.3947 4.41622 10.009 2.80273 12 2.80273ZM12 4.20215C10.7841 4.20215 9.79509 5.19136 9.79492 6.40723C9.79492 7.62323 10.784 8.61328 12 8.61328C13.2159 8.61318 14.2051 7.62317 14.2051 6.40723C14.2049 5.19142 13.2158 4.20225 12 4.20215Z" fill="#7527B2"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="header-row bottom" style="gap: 20px">
                        <div>
                            <div class="meta-info">
                                <div class="df aic">
                                    <span id="searchCaseId"></span>
                                    <button class="edit-btn" aria-label="Edit case">
                                        <svg class="icon-edit" viewBox="0 0 24 24">
                                            <path d="M4 20h16"/>
                                            <path d="M14.7 5.3l4 4L9 19.3l-4-4L14.7 5.3z"/>
                                        </svg>
                                    </button>
                                </div>
                                <div id="userName" style="white-space: nowrap"></div>
                                <div id="userGender"></div>
                                <div id="userAge"></div>
                            </div>
                            <div class="tabs">
                                <button class="tab" id="directionModalBtn">Направлення</button>
                                <button class="tab" id="caseSettingsModalBtn">Параметри кейсу</button>
                            </div>
                        </div>
                        <div class="infoHeader">
                            <div class="infoHeaderIcon">
                                <img src="./assets/info.svg" alt="info">
                            </div>
                            <div id="infoText"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="df jcsb contentCassette">
                <div class="cassettePlaceholder placeholder">
                    <div class="df aic jcc counter">
                        <svg class="counterAction" width="24" height="24" viewBox="0 0 24 24" fill="none"
                             xmlns="http://www.w3.org/2000/svg">
                            <path d="M7.01695 13C6.4553 13 6 12.5523 6 12C6 11.4477 6.4553 11 7.01695 11L16.9831 11C17.5447 11 18 11.4477 18 12C18 12.5523 17.5447 13 16.9831 13L7.01695 13Z"
                                  fill="#7527B2"/>
                        </svg>

                        <input id="countOfCassette" type="number" value="1" class="counterInput"
                               style="color: #B2AFBA">
                        <svg class="counterAction" width="24" height="24" viewBox="0 0 24 24" fill="none"
                             xmlns="http://www.w3.org/2000/svg">
                            <path d="M7.01695 13C6.4553 13 6 12.5523 6 12C6 11.4477 6.4553 11 7.01695 11L16.9831 11C17.5447 11 18 11.4477 18 12C18 12.5523 17.5447 13 16.9831 13L7.01695 13Z"
                                  fill="#7527B2"/>
                            <path d="M13 16.9831C13 17.5447 12.5523 18 12 18C11.4477 18 11 17.5447 11 16.9831L11 7.01695C11 6.4553 11.4477 6 12 6C12.5523 6 13 6.4553 13 7.01695V16.9831Z"
                                  fill="#7527B2"/>
                        </svg>

                    </div>
                    <div class="df aic jcsb">
                        <div class="actionButton borderRightNone create" id="createCassette"
                             data-help-text="Додати касету"
                             data-help-text-delete="Видалити касету"
                             style="background: #B2AFBA">
                            <img src="./assets/plusCircle.svg" alt="plusCircle">
                        </div>
                        <div class="actionButton borderLeftNone print" style="background: #B2AFBA" id="createCassetteAndPrint"  data-help-text="Додати і роздрукувати касету">
                            <img src="./assets/print.svg" alt="print">
                        </div>
                    </div>
                </div>
                <div class="df cassetteWrapper">
                    <div id="cassetteItems" class="df">

                    </div>
                    <div class="arrows" id="glassItemsScroll" style="border-bottom: none">
                        <div class="prev">
                            <img src="assets/arrow.svg" alt="arrow">
                        </div>
                        <div class="next">
                            <img src="assets/arrow.svg" alt="arrow">
                        </div>
                    </div>
                    <div class="arrows right" id="cassetteItemsScroll" style="border-top: none; border-bottom: none">
                        <div class="prev">
                            <img src="assets/arrow.svg" alt="arrow">
                        </div>
                        <div class="next">
                            <img src="assets/arrow.svg" alt="arrow">
                        </div>
                    </div>
                </div>
                <div class="commentsWrapper df fdc">
                    <div class="commentsWrapperTop">
                        Макроописание
                    </div>
                    <textarea id="sampleMacroDescription"></textarea>
                    <button class="commentsWrapperButton">Зберегти</button>
                </div>
            </div>
        </div>
    </div>
    <div id="caseSettingsModal" class="modalCustom">
        <div class="modalWrapper">
            <div class="modalContent">
                <div class="modalTitle">Параметри кейсу</div>
                <div class="caseSettings">
                    <div class="df">
                        <div class="caseSettingsContent df">

                        </div>
                        <div class="commentsWrapper df fdc">
                            <div class="commentsWrapperTop">
                                Макроопис зразка
                            </div>
                            <textarea id="caseSettingsComments"></textarea>
                        </div>
                    </div>
                    <button class="modalButton">
                        Зберегти
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="cassetteComments" class="modalCustom">
        <div class="modalWrapper">
            <div class="modalContent">
                <div class="modalTitle">Комментарий</div>
                <div>
                    <textarea class="cassetteCommentsArea" placeholder="Текст комментария..."></textarea>
                    <div class="modalSubmit">
                        Сохранить
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="caseDirection" class="modalCustom">
        <div class="modalWrapper">
            <div class="modalContent">
                <div class="modalTitle">Направлення</div>
                <div class="directorModalTop">
                    <!-- cor-id -->
                    <b>S25B01251</b>
                    <span class="mid"><span id="todayMeta"></span> | Фото/скан документу</span>
                </div>
                <div class="df gap4">
                    <div class="directorModalLeft"></div>

                    <div class="directorModalRight" id="uploadArea">
                        <div class="upload-box" id="uploadBox" tabindex="0">
                            <div class="upload-icon">
                                <svg viewBox="0 0 24 24"><path d="M12 4v10M7 9l5-5 5 5"/><rect x="4" y="18" width="16" height="2" rx="1"/></svg>
                            </div>
                            <span>Перетягніть сюди свої файли<br><b>або скануйте</b></span>
                            <small class="note">до 5 файлів</small>
                            <input type="file" id="fileInput" multiple accept="image/*,.pdf" hidden>
                        </div>
                    </div>
                </div>
                <div class="directorModalFooter">
                    <button class="btn btn-primary" id="caseDirectionSubmit">Зберегти</button>
                    <button class="btn btn-outline" id="caseDirectionScan">Сканувати</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="./COR_ID_Js/general_fun.js"></script>
<script src="./Printing/printers.js"></script>
<script src="./js/general.js"></script>
<script src="./js/alert.js"></script>
<script>
    const infoTextNODE = document.querySelector('#infoText')

    const helpTextShowHendler = (wrapperNODE) => {
        wrapperNODE.querySelectorAll("[data-help-text]").forEach(elem => {
            elem.addEventListener('mouseenter', () => {
                const dataSetAttr = elem.classList.contains('delete') ? "helpTextDelete" : "helpText"
                infoTextNODE.innerHTML = elem.dataset[dataSetAttr]
            });

            elem.addEventListener('mouseleave', () => {
                infoTextNODE.innerHTML = ""
            });
        })
    }
</script>
<script>
    const PATIENT_COR_ID = new URLSearchParams(window.location.search).get('userCorId')
    let cases = []

    //Draw HTML Template
    let lastActiveCaseIndex = null;
    let lastActiveSpecimenIndex = null;

    let casePageIndex = 0;
    let specimenPageIndex = 0;
    let cassettePageIndex = 0;
    let glassPageIndex = 0;

    const caseContentNODE = document.querySelector("#caseItems");
    const specimenContentNODE = document.querySelector("#specimenItems");
    const cassetteContentNODE = document.querySelector("#cassetteItems");

    const cassetteCommentModalNODE = document.querySelector("#cassetteComments");

    const countCaseInputNODE = document.querySelector('#countOfCase')
    const countOfSpecimenInputNODE = document.querySelector('#countOfSpecimen')
    const countOfCassetteInputNODE = document.querySelector('#countOfCassette')

    const macroDescriptionTextareaNODE = document.querySelector('#sampleMacroDescription')

    const toQueryString = (object) => {
        const searchParams = new URLSearchParams();
        for (const key in object) {
            searchParams.append(key, object[key]);
        }

        return searchParams.toString();
    }
    const printGlass = async (workCase, workSample, workCassette, workGlass) => {
        return getDevicesList()
            .then(devices => {
                const currentDevice = devices.find(({device_class}) => device_class === "GlassPrinter")

                return  {
                    "printer_ip": currentDevice.ip_address,
                    "model_id": 8,
                    "clinic_name": "",
                    "hooper": "",
                    "printing": true
                }
            })
    }
    const printCassette = async (workCase, workSample, workCassette) => {
        return getDevicesList()
            .then(devices => {
                const currentDevice = devices.find(({device_class}) => device_class === "GlassPrinter")

                return  {
                    "printer_ip": currentDevice.ip_address,
                    "model_id": 8,
                    "clinic_name": "",
                    "hooper": "",
                    "printing": true
                }
            })
    }

    const changePrintUI = (elementNODE, value) => {
        elementNODE.setAttribute('src', `./assets/${value ? "printActive" : "print"}.svg`)
    }
    const changePrintInModel = () => {
        let currentCase = cases[lastActiveCaseIndex]
        let currentSpecimen = currentCase.samples[lastActiveSpecimenIndex]

        const allCassettesInSpecimenPrinted = currentSpecimen.cassettes.every(({is_printed}) => is_printed)
        const allGlassesInSpecimenPrinted = currentSpecimen.cassettes.every((cassette) => cassette.glasses.every(({is_printed}) => is_printed))


        cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].is_printed_cassette = allCassettesInSpecimenPrinted
        cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].is_printed_glass = allGlassesInSpecimenPrinted

        currentCase = cases[lastActiveCaseIndex]
        let allSpecimen = currentCase.samples

        const allCassettesInCasePrinted = allSpecimen.every(({is_printed_cassette}) => is_printed_cassette)
        const allGlassesInCasePrinted = allSpecimen.every(({is_printed_glass}) => is_printed_glass)

        cases[lastActiveCaseIndex].is_printed_cassette = allCassettesInCasePrinted
        cases[lastActiveCaseIndex].is_printed_glass = allGlassesInCasePrinted


        const activeCaseCassettePrintNODE = document.querySelector('#caseItems .caseItem.active .casePrintCassette img')
        const activeCaseGlassNODE = document.querySelector('#caseItems .caseItem.active .casePrintGlass img')
        const activeSpecimenCassettePrintNODE = document.querySelector('#specimenItems .specimenItem.active .specimenPrintCassette img')
        const activeSpecimenGlassNODE = document.querySelector('#specimenItems .specimenItem.active .specimenPrintGlass img')

        changePrintUI(activeCaseCassettePrintNODE, allCassettesInCasePrinted)
        changePrintUI(activeCaseGlassNODE, allGlassesInCasePrinted)
        changePrintUI(activeSpecimenGlassNODE, allGlassesInSpecimenPrinted)
        changePrintUI(activeSpecimenCassettePrintNODE, allCassettesInSpecimenPrinted)



        if(allCassettesInSpecimenPrinted){
            cassetteContentNODE.querySelectorAll('.cassetteItem .cassettePrint img').forEach((elem) => {
                changePrintUI(elem, true)
            })
        }
        if(allGlassesInSpecimenPrinted){
            cassetteContentNODE.querySelectorAll('.glassItem .glassItemPaint img').forEach((elem) => {
                changePrintUI(elem, true)
            })
        }
    }

    const changeGlassPaint = (glassId, glassPaint) => {
        fetch(`${API_BASE_URL}/api/glasses/${glassId}/staining`, {
            method: "PATCH",
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                staining_type: glassPaint
            })
        })
            .then(res => res.json())
            .then(() => {
                showSuccessAlert(`Окрас скельця успішно зміненно`)
            })
    }
    const getGlassPaintPicker  = (elementNODE, parentWrapperQUERY, btnWrapperQUERY, callback) => {
        const currentGlassPickerNODE = elementNODE.closest(parentWrapperQUERY).querySelector('.glassPicker');

        if(currentGlassPickerNODE){
            currentGlassPickerNODE.remove()
            return;
        }

        const closeOutOfPopup = (e) => {
            if(!e.target.closest('.glassPicker') && !e.target.closest(btnWrapperQUERY)){
                div.remove()
                document.removeEventListener('click', closeOutOfPopup)
            }
        }

        const {top, right, bottom, left}  = elementNODE.getBoundingClientRect();
        const div = document.createElement('div');
        let bottomValue = "initial";
        let topValue = top + elementNODE.clientHeight;
        let leftValue = left - 7;
        let heightValue = window.innerHeight - topValue - 30;
        topValue = `${topValue}px`
        div.classList = "glassPicker"

        if(heightValue < 250){
            const bottomOffset = window.innerHeight - bottom;
            bottomValue = bottomOffset + elementNODE.clientHeight + 15;
            heightValue = window.innerHeight - bottomValue - 30 - 10
            bottomValue = `${bottomValue}px`
            topValue = "initial"
        }

        div.style.bottom = `${bottomValue}`;
        div.style.top = `${topValue}`;
        div.style.left = `${leftValue}px`;
        div.style.height = `${heightValue}px`
        elementNODE.closest(parentWrapperQUERY).prepend(div)


        glassPaintList.forEach( glassPaint => {
            const currentPaintId = div.closest(parentWrapperQUERY).dataset.glassPaintId
            const glassDiv = document.createElement('div');
            glassDiv.classList = `glassPickerList ${currentPaintId === glassPaint.id ? "active" : ""}`
            glassDiv.innerHTML = glassPaint.name

            glassDiv.addEventListener('click', (e) => {
                if(callback){
                    callback(glassPaint.id)
                }

                glassDiv.closest(parentWrapperQUERY).setAttribute('data-glass-paint-id', glassPaint.id)
                elementNODE.querySelector('.glassPaintValue').innerHTML = glassPaint.short
                div.remove()

                document.removeEventListener('click', closeOutOfPopup)
            })

            div.append(glassDiv)
        })

        document.addEventListener('click', closeOutOfPopup)
    }

    const scrollContent = (e, contentNODESelector, arrowsNODESelector, paginationUpDown = true, currentPaginationPage) => {
        const elem = e?.currentTarget;
        const animationDirection = paginationUpDown ? "top" : "left";
        let newPaginationPage = currentPaginationPage;

        const caseContentNODE = document.querySelectorAll(contentNODESelector);


        let caseContentHeight = 0;
        let caseContentScrollHeight = 0;

        caseContentNODE.forEach(elem => {
            if (elem.clientHeight > caseContentHeight) {
                caseContentHeight = elem[paginationUpDown ? "clientHeight" : "clientWidth"];
            }

            if (elem.scrollHeight > caseContentScrollHeight) {
                caseContentScrollHeight = elem[paginationUpDown ? "scrollHeight" : "scrollWidth"];
            }
        })

        if (!elem) {
            caseContentNODE.forEach(elem => {
                elem.scrollTo({[animationDirection]: caseContentHeight * newPaginationPage, behavior: 'smooth'});
            })
        }

        if (elem?.classList.contains('prev')) {
            newPaginationPage -= 1;
            caseContentNODE.forEach(elem => {
                elem.scrollTo({[animationDirection]: caseContentHeight * newPaginationPage, behavior: 'smooth'});
            })
        }

        if (elem?.classList.contains('next')) {
            newPaginationPage += 1;
            caseContentNODE.forEach(elem => {
                elem.scrollTo({[animationDirection]: caseContentHeight * newPaginationPage, behavior: 'smooth'});
            })
        }

        if ((caseContentScrollHeight - caseContentHeight * (newPaginationPage + 1)) < 0) {
            document.querySelector(`${arrowsNODESelector} .next`).classList.add('disable')
        } else {
            document.querySelector(`${arrowsNODESelector} .next`).classList.remove('disable')
        }

        if (newPaginationPage === 0) {
            document.querySelector(`${arrowsNODESelector} .prev`).classList.add('disable')
        } else {
            document.querySelector(`${arrowsNODESelector} .prev`).classList.remove('disable')
        }

        return newPaginationPage;
    };

    const setCaseEdit = () => {
        const commentsWrapperButtonNODE = document.querySelector('.commentsWrapperButton');
        const directorModalFooterNODE = document.querySelector('.directorModalFooter');
        const allPlaceholderNODE = document.querySelectorAll('.placeholder');
        const modalContentNODE = document.querySelectorAll('.modalContent');
        const modalSubmitNODE = document.querySelectorAll('.modalSubmit');
        const modalButtonNODE = document.querySelectorAll('.modalButton');

        const currentCase = cases[lastActiveCaseIndex];

        if(currentCase.grossing_status === "COMPLETED"){
            allPlaceholderNODE.forEach(elem => {
                if(elem.classList.contains('casePlaceholder')){
                    return;
                }

                elem.style.opacity = .4
                elem.style.pointerEvents = "none"
            })
            modalContentNODE.forEach(elem => {
                elem.style.pointerEvents = "none"
            })
            modalButtonNODE.forEach(elem => {
                elem.style.display = "none"
            })
            modalSubmitNODE.forEach(elem => {
                elem.style.display = "none"
            })
            directorModalFooterNODE.style.display = "none";
            commentsWrapperButtonNODE.style.display = "none";
            return;
        }

        allPlaceholderNODE.forEach(elem => {
            elem.style.opacity = 1;
            elem.style.pointerEvents = "auto"
        })
        modalContentNODE.forEach(elem => {
            elem.style.pointerEvents = "auto"
        })
        modalButtonNODE.forEach(elem => {
            elem.style.display = "block"
        })
        modalSubmitNODE.forEach(elem => {
            elem.style.display = "block"
        })
        directorModalFooterNODE.style.display = "block";
        commentsWrapperButtonNODE.style = "";
    }
    const setPathomorphologyTemplate = (activeCaseIndex, activeSpecimenIndex) => {
        if ((activeCaseIndex === lastActiveCaseIndex) && (activeSpecimenIndex === lastActiveSpecimenIndex)) {
            return;
        }

        addActiveClass(".caseItem", activeCaseIndex)

        const currentCase = cases[activeCaseIndex];
        const currentSpecimen = currentCase.samples[activeSpecimenIndex];
        macroDescriptionTextareaNODE.value = currentSpecimen.macro_description || "";

        document.querySelector('#searchCaseId').innerHTML = currentCase.case_code
        document.querySelector('#searchCaseId').style.color = getCaseColor(currentCase)

        cassetteContentNODE.innerHTML = ""

        if (activeCaseIndex !== lastActiveCaseIndex) {
            specimenContentNODE.innerHTML = ""

            currentCase.samples.map((specimen, specimenIndex) => {
                specimenContentNODE.append(specimenTemplate(specimen))

                if (specimenIndex === activeSpecimenIndex) {
                    currentSpecimen.cassettes.map((cassette, index) => {
                        cassetteContentNODE.append(cassetteTemplate(cassette, currentSpecimen.label, index))
                    })
                }
            })

            createOrDeleteGlassHandler()
            changeEntityCountHandler("#cassetteItems .counter input")
            addActiveClass(".specimenItem", activeSpecimenIndex)

            lastActiveCaseIndex = activeCaseIndex;
            lastActiveSpecimenIndex = activeSpecimenIndex;
            countOfSpecimenInputNODE.setAttribute('data-delete-count', currentCase.samples.length - 1)
            countOfCassetteInputNODE.setAttribute('data-delete-count', currentSpecimen.cassettes.length - 1)

            return;
        }

        currentSpecimen.cassettes.map((cassette, index) => {
            cassetteContentNODE.append(cassetteTemplate(cassette, currentSpecimen.label, index))
        })

        createOrDeleteGlassHandler()
        changeEntityCountHandler("#cassetteItems .counter input")
        addActiveClass(".specimenItem", activeSpecimenIndex)

        countOfCassetteInputNODE.setAttribute('data-delete-count', currentSpecimen.cassettes.length - 1)
        lastActiveCaseIndex = activeCaseIndex;
        lastActiveSpecimenIndex = activeSpecimenIndex;
    }
    const setAllCases = () => {
        if(checkToken()){
            fetch(`${API_BASE_URL}/api/doctor/patients/${PATIENT_COR_ID}`, {
                method: "GET",
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                },
            })
                .then(res => res.json())
                .then(userData => {
                    document.querySelector('#userName').innerHTML = `${userData.surname || ""} ${userData.first_name || ""} ${userData.middle_name || ""}`;
                    document.querySelector('#userGender').innerHTML = userData.sex === "M" ? "Чол" : "Жін";
                    document.querySelector('#userAge').innerHTML = `${(userData.age || "")  ? `${userData.age}р` : ''}`;

                    fetch(`${API_BASE_URL}/api/cases/patients/${PATIENT_COR_ID}/overview`, {
                        method: "GET",
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        },
                    })
                        .then(res => res.json())
                        .then(casesList => {
                            cases = casesList.all_cases

                            if(!casesList.first_case_details){
                                return;
                            }

                            cases[0].samples = casesList.first_case_details.samples.map(({cassettes, ...sampleData}, index) => {
                                return {
                                    ...sampleData,
                                    ...(!index ? {cassettes} : {})
                                }
                            })

                            macroDescriptionTextareaNODE.value = cases[0].samples.macro_description || "";

                            cases.forEach((currentCase, index) => {
                                caseContentNODE.append(caseTemplate(currentCase, !index))
                            })

                            setPathomorphologyTemplate(0, 0)
                            setCaseEdit()
                            countCaseInputNODE.setAttribute('data-delete-count', cases.length - 1)
                        })
                })
        }
    }

    const createCassetteHandler = async (data, query = "") => {
        return fetch(`${API_BASE_URL}/api/cassettes/create${query}`, {
            method: "POST",
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        })
            .then(res => res.json())
            .then(newCassettes => {
                const currentSamples = cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex];

                cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].cassettes = [
                    ...cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].cassettes,
                    ...newCassettes,
                ];
                cases[lastActiveCaseIndex].cassette_count += +countOfCassetteInputNODE.value;
                cases[lastActiveCaseIndex].glass_count += +countOfCassetteInputNODE.value;
                cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].cassette_count += +countOfCassetteInputNODE.value;
                cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].glass_count += +countOfCassetteInputNODE.value;

                let currentCassettesList = currentSamples.cassettes;

                cassetteContentNODE.innerHTML = "";

                currentCassettesList.forEach((cassette, index) => {
                    cassetteContentNODE.append(cassetteTemplate(cassette, currentSamples.label, index))
                })


                setPathomorphologyTemplate(lastActiveCaseIndex, lastActiveSpecimenIndex)

                countOfCassetteInputNODE.setAttribute('data-delete-count', currentCassettesList.length - 1)


                cassettePageIndex = scrollContent(null, "#cassetteItems", "#cassetteItemsScroll", false, 0)
                glassPageIndex = scrollContent(null, ".glassItems", "#glassItemsScroll", true, 0)
                createOrDeleteGlassHandler()
                changeEntityCountHandler("#cassetteItems .counter input")
                changeItemCountOnEntity()
                showSuccessAlert(`Касет${+countOfCassetteInputNODE.value>1 ? "и" : "а"} успішно ствернн${+countOfCassetteInputNODE.value>1 ? "і" : "а"}`)

                countOfCassetteInputNODE.value = 1;
                changePrintInModel()

                return newCassettes
            })
    }
    const createGlassHandler = async (elem, cassetteIndex, data, query = "") => {
        const countOfGlassInput = elem.querySelector('.counterInput')

        fetch(`${API_BASE_URL}/api/glasses/create${query}`, {
            method: "POST",
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        })
            .then(res => res.json())
            .then(newGlasses => {
                cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].cassettes[cassetteIndex].glasses = [
                    ...cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].cassettes[cassetteIndex].glasses,
                    ...newGlasses,
                ];
                cases[lastActiveCaseIndex].glass_count += +countOfGlassInput.value;
                cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].glass_count += +countOfGlassInput.value;

                const glassContentNODE = elem.nextElementSibling;

                newGlasses.forEach((glass) => {
                    glassContentNODE.append(glassTemplate(glass))
                })

                glassContentNODE
                    .closest('.cassetteColumn')
                    .querySelector('.counterInput')
                    .setAttribute('data-delete-count', cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].cassettes[cassetteIndex].glasses.length - 1)
                changeItemCountOnEntity()
                glassPageIndex = scrollContent(null, ".glassItems", "#glassItemsScroll", true, 0)
                showSuccessAlert(`Скельц${+countOfGlassInput.value > 1 ? "я" : "е"} успішно ствернн${+countOfGlassInput.value>1 ? "і" : "е"}`)
                countOfGlassInput.value = 1;
                changePrintInModel()
            })
    }

    //ENTITY HTML TEMPLATES
    const caseTemplate = (currentCase, isActive) => {
        const caseNewNODE = document.createElement('div');
        caseNewNODE.classList.add('caseItem', ...(isActive ? ['active'] : []));
        caseNewNODE.innerHTML = `
            <div class="caseItemTop df jcsb aic">
                        <div class="caseItemImg">
                            <img src="./assets/caseItem.svg" alt="caseItem">
                            <div class="caseItemImgCount">
                                ${currentCase.bank_count}
                            </div>
                        </div>
                        <div>
                            <div class="caseItemDate">
                                ${new Date(currentCase.creation_date).toLocaleDateString()}
                            </div>
                            <div class="caseItemMark" style="color: ${getCaseColor(currentCase)}">
                                ${currentCase.case_code}
                            </div>
                        </div>
                    </div>
            <div class="caseItemBottom df gap8 aic jcsb">
                        <div class="df aic fdc">
                            <div class="infoPlate qr">
                                QR
                            </div>
                            <div class="casePrintQR" data-help-text="Роздрукувати QR код дослідженням">
                                <img src="./assets/${currentCase.is_printed_qr ? "printActive" : "print"}.svg" alt="print">
                            </div>
                        </div>
                        <div class="df aic fdc">
                            <div class="infoPlate cassette">
                                ${currentCase.cassette_count}
                            </div>
                            <div class="casePrintCassette" data-help-text="Роздрукувати всі касети дослідження">
                                <img src="./assets/${currentCase.is_printed_cassette ? "printActive" : "print"}.svg" alt="print">
                            </div>
                        </div>
                        <div class="df aic fdc">
                            <div class="infoPlate glass">
                                ${currentCase.glass_count}
                            </div>
                            <div class="casePrintGlass" data-help-text="Роздрукувати всі скельця дослідження">
                                <img src="./assets/${currentCase.is_printed_glass ? "printActive" : "print"}.svg" alt="print">
                            </div>
                        </div>
                    </div>
        `

        helpTextShowHendler(caseNewNODE)

        caseNewNODE.querySelector('.casePrintQR').addEventListener('click', (e) => {
            const elem = e.currentTarget;

             fetch(`${API_BASE_URL}/api/cases/${currentCase.id}/print_qr?printing=true`, {
                method: "PATCH",
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                    "Content-Type": "application/json"
                },
            })
                .then(res => res.json())
                .then(() => {
                    showSuccessAlert("QR дослідження раздрукованно")
                    changePrintUI(elem.querySelector('img'), true)
                })
        })
        caseNewNODE.querySelector('.casePrintCassette').addEventListener('click', async (e) => {
            setTimeout(() => {
                const elem = e.currentTarget;

                printCassette()
                    .then(printResultData => {
                        fetch(`${API_BASE_URL}/api/cases/${currentCase.id}/print_cassettes?printing=true`, {
                            method: "PATCH",
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify(printResultData)
                        })
                            .then(res => res.json())
                            .then(() => {
                                cases[lastActiveCaseIndex].samples = (
                                    cases[lastActiveCaseIndex].samples
                                        .map((sample) => ({
                                            ...sample,
                                            cassettes: sample.cassettes.map((cassette) => ({
                                                ...cassette,
                                                is_printed: true
                                            }))
                                        }))
                                )

                                showSuccessAlert("Касети дослідження раздрукованно")
                                changePrintInModel();
                                changePrintUI(elem.querySelector('img'), true)
                            })
                    })
            }, 100)
        })
        caseNewNODE.querySelector('.casePrintGlass').addEventListener('click', async (e) => {
            setTimeout(() => {
                const elem = e.currentTarget;

                printGlass()
                    .then(printResultData => {
                        fetch(`${API_BASE_URL}/api/cases/${currentCase.id}/print_glasses?printing=true`, {
                            method: "PATCH",
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify(printResultData)
                        })
                            .then(res => res.json())
                            .then(() => {
                                cases[lastActiveCaseIndex].samples = (
                                    cases[lastActiveCaseIndex].samples
                                        .map((sample) => ({
                                            ...sample,
                                            cassettes: sample.cassettes.map((cassette) => ({
                                                ...cassette,
                                                glasses: cassette.glasses.map((glass) => ({
                                                    ...glass,
                                                    is_printed: true
                                                }))
                                            }))
                                        }))
                                )

                                showSuccessAlert("Скельця дослідження раздрукованно")
                                changePrintInModel();
                                changePrintUI(elem.querySelector('img'), true)
                            })
                    })
            }, 100)
        })

        caseNewNODE.addEventListener("click", () => {
            fetch(`${API_BASE_URL}/api/cases/${currentCase.id}`, {
                method: "GET",
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                },
            })
                .then(res => res.json())
                .then(currentCase => {
                    const currentCaseIndex = cases.findIndex(({id}) => id === currentCase.id)
                    cases[currentCaseIndex].samples = currentCase.samples;

                    setPathomorphologyTemplate(currentCaseIndex, 0)
                    setCaseEdit()
                })
        });
        return caseNewNODE
    }
    const specimenTemplate = (currentSpecimen, isActive) => {
        const specimenNewNODE = document.createElement('div');
        specimenNewNODE.classList.add('specimenItem', ...(isActive ? ['active'] : []));
        specimenNewNODE.innerHTML = `
           <div class="df jcsb aic">
                        <div class="caseItemImg">
                            <img src="./assets/specimenItem.svg" alt="specimenItem">
                            <div class="caseItemImgCount">
                                ${currentSpecimen.sample_number}
                            </div>
                        </div>
                        <div class="specimenItemArchive" style="cursor: pointer" data-help-text="Наявність архіву">
                            <img src="./assets/${currentSpecimen.archive ? "archiveActive" : "archive"}.svg" alt="archive">
                        </div>
                    </div>
                    <div class="specimenItemBottom df gap8 aic">
                        <div class="df aic fdc">
                            <div class="infoPlate cassette">
                                ${currentSpecimen.cassette_count}
                            </div>
                            <div class="specimenPrintCassette" data-help-text="Роздрукувати всі касети зразка">
                                <img src="./assets/${currentSpecimen.is_printed_cassette ? "printActive" : "print"}.svg" alt="print">
                            </div>
                        </div>
                        <div class="df aic fdc">
                            <div class="infoPlate glass">
                                ${currentSpecimen.glass_count}
                            </div>
                            <div class="specimenPrintGlass" data-help-text="Роздрукувати всі скельця зразка">
                                <img src="./assets/${currentSpecimen.is_printed_glass ? "printActive" : "print"}.svg" alt="print">
                            </div>
                        </div>
                    </div>
        `

        helpTextShowHendler(specimenNewNODE)

        specimenNewNODE.querySelector('.specimenPrintGlass').addEventListener('click', async (e) => {
            setTimeout(async () => {
                const elem = e.currentTarget;

                printGlass()
                    .then(printResultData => {
                        fetch(`${API_BASE_URL}/api/samples/${currentSpecimen.id}/print_glasses?printing=true`, {
                            method: "PATCH",
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify(printResultData)
                        })
                            .then(res => res.json())
                            .then(() => {
                                cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].cassettes = (
                                    cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].cassettes
                                        .map((cassette) => ({
                                            ...cassette,
                                            glasses: cassette.glasses.map((glass) => ({
                                                ...glass,
                                                is_printed: true
                                            }))
                                        }))
                                )


                                showSuccessAlert("Скельця зразка раздрукованно")
                                changePrintInModel();
                                changePrintUI(elem.querySelector('img'), true)
                            })
                    })

            }, 100)
        })

        specimenNewNODE.querySelector('.specimenPrintCassette').addEventListener('click', async (e) => {
            setTimeout(async () => {
                printCassette()
                    .then(printResultData => {
                        fetch(`${API_BASE_URL}/api/samples/${currentSpecimen.id}/print_cassettes?printing=true`, {
                            method: "PATCH",
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify(printResultData)
                        })
                            .then(res => res.json())
                            .then(() => {
                                cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].cassettes = (
                                    cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].cassettes
                                        .map((cassette) => ({
                                            ...cassette,
                                            is_printed: true
                                        }))
                                )

                                showSuccessAlert("Касети зразка раздрукованно")
                                changePrintInModel();
                                changePrintUI(elem.querySelector('img'), true)
                            })
                    })
            }, 100)
        })

        specimenNewNODE.querySelector('.specimenItemArchive').addEventListener('click', (e) => {
            e.stopPropagation()
            const samplesIndex = cases[lastActiveCaseIndex].samples.findIndex(({id}) => id === currentSpecimen.id)
            const samplesArchiveValue = !cases[lastActiveCaseIndex].samples[samplesIndex].archive;

            fetch(`${API_BASE_URL}/api/samples/archive/${currentSpecimen.id}?archive=${samplesArchiveValue}`, {
                method: "PUT",
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                    "Content-Type": "application/json"
                },
            })
                .then(res => res.json())
                .then(() => {
                    cases[lastActiveCaseIndex].samples[samplesIndex].archive = samplesArchiveValue;

                    const archiveIcon = samplesArchiveValue ? "archiveActive" : "archive";

                    specimenNewNODE.querySelector('.specimenItemArchive img')
                        .setAttribute('src', `./assets/${archiveIcon}.svg`)
                })

        })

        specimenNewNODE.addEventListener("click", () => {
            fetch(`${API_BASE_URL}/api/samples/${currentSpecimen.id}`, {
                method: "GET",
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                },
            })
                .then(res => res.json())
                .then(currentSpecimen => {
                    const currentCase = cases[lastActiveCaseIndex]
                    const currentSpecimenIndex = currentCase.samples.findIndex(({id}) => id === currentSpecimen.id)
                    currentCase.samples[currentSpecimenIndex] = currentSpecimen;


                    setPathomorphologyTemplate(lastActiveCaseIndex, currentSpecimenIndex)
                })
        });


        return specimenNewNODE
    }
    const cassetteTemplate = (currentCassette, label, index) => {
        const cassetteColumnNODE = document.createElement('div');
        cassetteColumnNODE.classList.add("cassetteColumn")
        cassetteColumnNODE.innerHTML = `
            <div class="cassetteItem df aic jcc">
                <div class="cassetteItemImg">
                    <img src="./assets/cassetteItem.svg" alt="caseItem">
                    <div class="cassetteAction df jcsb aic">
                        <div>${currentCassette.cassette_number}</div>
                        <div class="cassetteComment" data-help-text="Коментар">
                            <img src="./assets/${currentCassette.comment?.length ? "commentActive" : "comment"}.svg" alt="comment">
                        </div>
                        <div class="cassettePrint" data-help-text="Друг касети"><img src="./assets/${currentCassette.is_printed ? "printActive" : "print"}.svg" alt="print"></div>
                    </div>
                </div>
            </div>
            <div class="glassPlaceholder placeholder" data-glass-paint-id="H&E" data-glass-index='${index}'>
                <div class="df aic jcc counter">
                    <svg class="counterAction" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M7.01695 13C6.4553 13 6 12.5523 6 12C6 11.4477 6.4553 11 7.01695 11L16.9831 11C17.5447 11 18 11.4477 18 12C18 12.5523 17.5447 13 16.9831 13L7.01695 13Z" fill="#7527B2"/>
                    </svg>
                    <input  data-delete-count="${currentCassette.glasses.length - 1}" type="number" value="1" class="counterInput" style="color: #88C6FF">
                    <svg class="counterAction" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M7.01695 13C6.4553 13 6 12.5523 6 12C6 11.4477 6.4553 11 7.01695 11L16.9831 11C17.5447 11 18 11.4477 18 12C18 12.5523 17.5447 13 16.9831 13L7.01695 13Z" fill="#7527B2"/>
                        <path d="M13 16.9831C13 17.5447 12.5523 18 12 18C11.4477 18 11 17.5447 11 16.9831L11 7.01695C11 6.4553 11.4477 6 12 6C12.5523 6 13 6.4553 13 7.01695V16.9831Z" fill="#7527B2"/>
                    </svg>
                </div>
                <div class="df aic jcsb glassMark" data-help-text="Фарбування скельця">
                    <div class="glassPaintValue">
                        H&E
                    </div>
                    <div>
                        <img src="assets/arrow.svg" alt="arrowDown">
                    </div>
                </div>
                <div class="df aic jcsb">
                    <div class="actionButton borderRightNone create" data-help-text="Додати скельце" data-help-text-delete="Видалити скельце" id="createGlass">
                        <img src="./assets/plusCircle.svg" alt="plusCircle">
                    </div>
                    <div class="actionButton borderLeftNone print" id="createGlassAndPrint"  data-help-text="Додати і роздрукувати скельце">
                        <img src="./assets/print.svg" alt="print">
                    </div>
                </div>
            </div>
            <div class="glassItems df fdc">

            </div>
        `;

        currentCassette.glasses.forEach((glass) => cassetteColumnNODE.querySelector('.glassItems').append(glassTemplate(glass)))

        helpTextShowHendler(cassetteColumnNODE)

        cassetteColumnNODE.querySelector('.cassetteComment').addEventListener('click', () => {
            cassetteCommentModalNODE.dataset.id = currentCassette.id;
            cassetteCommentModalNODE.dataset.index = index;
            cassetteCommentModalNODE.classList.add('open');

            const currentUpdatedCassette = cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].cassettes[index];

            cassetteCommentModalNODE.querySelector('textarea').value = currentUpdatedCassette.comment
        })

        cassetteColumnNODE.querySelector('.cassettePrint').addEventListener('click', () => {

            if(checkToken()){
                printCassette()
                    .then(printResultData => {
                        fetch(`${API_BASE_URL}/api/cassettes/${currentCassette.id}/printed?printed=true`, {
                            method: "PATCH",
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                                ...printResultData,
                                cassete_id: currentCassette?.id
                            })
                        })
                            .then(res => res.json())
                            .then(() => {
                                const currentCase = cases[lastActiveCaseIndex];
                                const currentSpecimen = currentCase.samples[lastActiveSpecimenIndex];
                                const currentCassetteIndex = currentSpecimen.cassettes.findIndex(({id}) => id === currentCassette.id )

                                cases[lastActiveCaseIndex]
                                    .samples[lastActiveSpecimenIndex]
                                    .cassettes[currentCassetteIndex]
                                    .is_printed = true;

                                showSuccessAlert("Касета відсканованна")
                                changePrintInModel();
                                changePrintUI(cassetteColumnNODE.querySelector('.cassettePrint img'), true)
                            })
                    })
                    .catch(e => {
                        showErrorAlert(e?.response?.message || e?.message)
                    })
            }
        })

        cassetteColumnNODE.querySelector('.glassMark').addEventListener('click', (e) => {

            const elem = e.currentTarget;

            getGlassPaintPicker(elem, ".glassPlaceholder", ".glassMark")
        })

        return cassetteColumnNODE
    }
    const glassTemplate = (currentGlass) => {
        const currentPrint = glassPaintList.find((glassPaint) => glassPaint.id === currentGlass.staining)
        const div = document.createElement('div');
        div.classList = "glassItem df aic jcsb";
        div.innerHTML = `
        <div class="glassItemPicker">
            ${currentGlass.glass_number} <span class="glassPaintValue">${currentPrint.short}</span>
        </div>
        <div class="glassItemPaint" style="cursor: pointer">
            <img src="./assets/${currentGlass.is_printed ? "printActive" : "print"}.svg" alt="print">
        </div>
        `;

        div.querySelector('.glassItemPicker').addEventListener('click', (e) => {
            const elem = e.currentTarget;

            getGlassPaintPicker(elem, ".glassItem", ".glassItemPicker", (glassPaint) => changeGlassPaint(currentGlass?.id, glassPaint))
        })

        div.querySelector('.glassItemPaint').addEventListener('click', (e) => {
            if(checkToken()){
                printGlass()
                    .then(printResultData => {
                        fetch(`${API_BASE_URL}/api/glasses/${currentGlass.id}/printed?printing=true`, {
                            method: "PATCH",
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                                ...printResultData,
                                "glass_id": currentGlass.id,
                            })
                        })
                            .then(res => res.json())
                            .then(() => {
                                const currentCase = cases[lastActiveCaseIndex];
                                const currentSpecimen = currentCase.samples[lastActiveSpecimenIndex];
                                const {currentCassetteIndex, currentGlassIndex} = currentSpecimen.cassettes.reduce((accum, cassette, index) => {
                                    const glassIndex = cassette.glasses.findIndex(({id}) => id === currentGlass.id)

                                    if(glassIndex === -1){
                                        return accum
                                    }

                                    return {
                                        currentCassetteIndex: index,
                                        currentGlassIndex: glassIndex
                                    }
                                }, {})

                                cases[lastActiveCaseIndex]
                                    .samples[lastActiveSpecimenIndex]
                                    .cassettes[currentCassetteIndex]
                                    .glasses[currentGlassIndex]
                                    .is_printed = true;

                                showSuccessAlert("Скельце раздрукованно")
                                changePrintInModel();
                                changePrintUI(div.querySelector('.glassItemPaint img'), true)
                            })
                    })
                    .catch(e => {
                        showErrorAlert(e?.response?.message || e?.message)
                    })
            }
        })


        return div
    }

    //ENTITY CREATE
    const createOrDeleteCaseHandler = () => {
        const createCaseBtn = document.querySelector('#createCase')

        createCaseBtn.addEventListener('click', () => {
            lastActiveCaseIndex = null;
            lastActiveSpecimenIndex = null;

            const placeholderNODE = createCaseBtn.closest('.placeholder')
            const isDelete = placeholderNODE.classList.contains('negative')

            if (isDelete) {
                return;
                const deletedCasesIds = [...cases]
                    .reverse()
                    .slice(0, +countCaseInputNODE.value)
                    .map(({id}) => id);

                fetch(`${API_BASE_URL}/api/cases/delete`, {
                    method: "DELETE",
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        case_ids: deletedCasesIds,
                    })
                })
                    .then(res => res.json())
                    .then(() => {
                        cases = cases.filter(currentCase => !deletedCasesIds.includes(currentCase.id));
                        [...caseContentNODE.querySelectorAll('.caseItem')]
                            .reverse()
                            .slice(0, +countCaseInputNODE.value).forEach(elem => {
                            elem.remove()
                        });
                        setPathomorphologyTemplate(0, 0);


                        casePageIndex = scrollContent(null, '#caseItems', "#caseItemsScroll", true, 0)
                        specimenPageIndex = scrollContent(null, "#specimenItems", "#specimenItemsScroll", true, 0)
                        cassettePageIndex = scrollContent(null, "#cassetteItems", "#cassetteItemsScroll", false, 0)
                        glassPageIndex = scrollContent(null, ".glassItems", "#glassItemsScroll", true, 0)

                        showSuccessAlert(`Кейс${+countCaseInputNODE.value>1 ? "и" : ""} успішно видаленно`)

                        countCaseInputNODE.value = 1;
                        countCaseInputNODE.setAttribute('data-delete-count', cases.length - 1)

                    })
            }
            if (!isDelete) {
                fetch(`${API_BASE_URL}/api/cases/create`, {
                    method: "POST",
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        patient_cor_id: PATIENT_COR_ID,
                        num_cases: 1,
                        num_samples: +countCaseInputNODE.value,
                        urgency: parentMark,
                        material_type: childMark
                    })
                })
                    .then(res => res.json())
                    .then((newCase) => {
                        const newCaseWithInfo = newCase.all_cases.reverse();
                        newCaseWithInfo[0].samples = newCase.first_case_details.samples;
                        cases = [...newCaseWithInfo, ...cases];

                        newCaseWithInfo.reverse().map(currentCase => {
                            caseContentNODE.prepend(caseTemplate(currentCase, 0))
                        })

                        setPathomorphologyTemplate(0, 0)
                        casePageIndex = scrollContent(null, '#caseItems', "#caseItemsScroll", true, 0)
                        specimenPageIndex = scrollContent(null, "#specimenItems", "#specimenItemsScroll", true, 0)
                        cassettePageIndex = scrollContent(null, "#cassetteItems", "#cassetteItemsScroll", false, 0)
                        glassPageIndex = scrollContent(null, ".glassItems", "#glassItemsScroll", true, 0)

                        showSuccessAlert(`Кейс${+countCaseInputNODE.value>1 ? "и" : ""} успішно створенно`)

                        countCaseInputNODE.value = 1;
                        countCaseInputNODE.setAttribute('data-delete-count', cases.length - 1)

                        setCaseEdit()
                    })
            }

            counterReset()
        })
    }
    const createOrDeleteSpecimenHandler = () => {
        const createSpecimenBtn = document.querySelector('#createSpecimen')

        createSpecimenBtn.addEventListener('click', () => {
            lastActiveSpecimenIndex = null;

            const placeholderNODE = createSpecimenBtn.closest('.placeholder')
            const isDelete = placeholderNODE.classList.contains('negative')

            if (isDelete) {
                const deletedSamplesList = [...cases[lastActiveCaseIndex].samples]
                    .reverse()
                    .slice(0, +countOfSpecimenInputNODE.value);

                fetch(`${API_BASE_URL}/api/samples/delete`, {
                    method: "DELETE",
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        sample_ids: deletedSamplesList.map(({id}) => id),
                    }),
                })
                    .then(res => res.json())
                    .then(() => {
                        cases[lastActiveCaseIndex].samples = cases[lastActiveCaseIndex].samples
                            .filter(sample => !deletedSamplesList.map(({id}) => id).includes(sample.id))

                        setPathomorphologyTemplate(lastActiveCaseIndex, 0);

                        [...specimenContentNODE.querySelectorAll('.specimenItem')]
                            .reverse()
                            .slice(0, +countOfSpecimenInputNODE.value)
                            .forEach(elem => {
                                elem.remove()
                            })


                        const deletedGlassCount = deletedSamplesList.reduce((deletedGlassCount, sample) => {
                            return deletedGlassCount + sample.glass_count
                        }, 0);
                        const deletedCassettesCount = deletedSamplesList.reduce((deletedGlassCount, sample) => {
                            return deletedGlassCount + sample.cassette_count
                        }, 0);
                        cases[lastActiveCaseIndex].cassette_count -= deletedCassettesCount;
                        cases[lastActiveCaseIndex].glass_count -= deletedGlassCount;
                        cases[lastActiveCaseIndex].bank_count -= +countOfSpecimenInputNODE.value;

                        specimenPageIndex = scrollContent(null, "#specimenItems", "#specimenItemsScroll", true, 0)
                        cassettePageIndex = scrollContent(null, "#cassetteItems", "#cassetteItemsScroll", false, 0)
                        glassPageIndex = scrollContent(null, ".glassItems", "#glassItemsScroll", true, 0)

                        changeItemCountOnEntity()
                        showSuccessAlert(`Зраз${+countOfSpecimenInputNODE.value> 1 ? "ки" : "ок"} успішно видаленно`)

                        countOfSpecimenInputNODE.setAttribute('data-delete-count', cases[lastActiveCaseIndex].samples.length - 1)
                        countOfSpecimenInputNODE.value = 1;
                        changePrintInModel()
                    })
            }

            if (!isDelete) {
                fetch(`${API_BASE_URL}/api/samples/create`, {
                    method: "POST",
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        case_id: cases[lastActiveCaseIndex].id,
                        num_samples: +countOfSpecimenInputNODE.value,
                    })
                })
                    .then(res => res.json())
                    .then(newSamples => {
                        const newSamplesInfo = newSamples.created_samples;
                        newSamplesInfo[0].cassettes = newSamples.first_sample_details.cassettes;

                        cases[lastActiveCaseIndex].samples = [
                            ...cases[lastActiveCaseIndex].samples,
                            ...newSamplesInfo,
                        ];
                        cases[lastActiveCaseIndex].cassette_count += +countOfSpecimenInputNODE.value
                        cases[lastActiveCaseIndex].bank_count += +countOfSpecimenInputNODE.value
                        cases[lastActiveCaseIndex].glass_count += +countOfSpecimenInputNODE.value

                        newSamples.created_samples.forEach(specimen => {
                            specimenContentNODE.append(specimenTemplate(specimen))
                        })


                        setPathomorphologyTemplate(lastActiveCaseIndex, 0)
                        changeItemCountOnEntity();

                        specimenPageIndex = scrollContent(null, "#specimenItems", "#specimenItemsScroll", true, 0)
                        cassettePageIndex = scrollContent(null, "#cassetteItems", "#cassetteItemsScroll", false, 0)
                        glassPageIndex = scrollContent(null, ".glassItems", "#glassItemsScroll", true, 0)

                        showSuccessAlert(`Зраз${+countOfSpecimenInputNODE.value>1 ? "ки" : "ок"} успішно створенно`)

                        countOfSpecimenInputNODE.setAttribute('data-delete-count', cases[lastActiveCaseIndex].samples.length - 1)
                        countOfSpecimenInputNODE.value = 1;
                        changePrintInModel()
                    })
            }

            counterReset()
        })
    }
    const createOrDeleteCassetteHandler = () => {
        const createCassetteBtn = document.querySelector('#createCassette')
        const createCassetteAndPrintBtn = document.querySelector('#createCassetteAndPrint')

        createCassetteBtn.addEventListener('click', () => {
            const currentSamples = cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex];
            const placeholderNODE = createCassetteBtn.closest('.placeholder')
            const isDelete = placeholderNODE.classList.contains('negative')

            if (isDelete) {
                const deletedCassettesList = [...currentSamples.cassettes]
                    .reverse()
                    .slice(0, +countOfCassetteInputNODE.value)

                fetch(`${API_BASE_URL}/api/cassettes/delete`, {
                    method: "DELETE",
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        cassette_ids: deletedCassettesList.map(({id}) => id),
                    })
                })
                    .then(res => res.json())
                    .then(() => {
                        cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].cassettes = (
                            cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].cassettes
                                .filter(cassette => !deletedCassettesList.map(({id}) => id).includes(cassette.id))
                        );

                        const deletedGlassCount = deletedCassettesList.reduce((deletedGlassCount, cassette) => {
                            return deletedGlassCount + cassette.glasses.length
                        }, 0);
                        cases[lastActiveCaseIndex].cassette_count -= +countOfCassetteInputNODE.value;
                        cases[lastActiveCaseIndex].glass_count -= deletedGlassCount;
                        cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].cassette_count -= +countOfCassetteInputNODE.value;
                        cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].glass_count -= deletedGlassCount;


                        [...cassetteContentNODE.querySelectorAll('.cassetteColumn')]
                            .reverse()
                            .slice(0, +countOfCassetteInputNODE.value).forEach(elem => {
                            elem.remove()
                        })

                        changeItemCountOnEntity()

                        cassettePageIndex = scrollContent(null, "#cassetteItems", "#cassetteItemsScroll", false, 0)
                        glassPageIndex = scrollContent(null, ".glassItems", "#glassItemsScroll", true, 0)

                        showSuccessAlert(`Касет${+countOfCassetteInputNODE.value>1 ? "и" : "а"} успішно видаленн${+countOfCassetteInputNODE.value>1 ? "и" : "а"}`)

                        countOfCassetteInputNODE.setAttribute('data-delete-count', cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].cassettes.length - 1)
                        countOfCassetteInputNODE.value = 1;
                        changePrintInModel()
                    })
            }

            if (!isDelete) {
                createCassetteHandler({
                    sample_id: currentSamples.id,
                    num_cassettes: +countOfCassetteInputNODE.value,
                    num_glasses_per_cassette: 1,
                })
            }

            counterReset()
        })

        createCassetteAndPrintBtn.addEventListener('click', () => {
            const currentSamples = cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex];

            createCassetteHandler({
                sample_id: currentSamples.id,
                num_cassettes: +countOfCassetteInputNODE.value,
                num_glasses_per_cassette: 1,
            }, "?printing=true")
        })
    }
    const createOrDeleteGlassHandler = () => {
        const createGlassBtns = document.querySelectorAll('*[data-glass-index]')

        createGlassBtns.forEach((elem, index) => {
            const createGlassBtnNODE = elem.querySelector('#createGlass');
            const createGlassAndPrintBtnNODE = elem.querySelector('#createGlassAndPrint');

            createGlassBtnNODE.addEventListener('click', () => {
                const placeholderNODE = createGlassBtnNODE.closest('.placeholder')
                const isDelete = placeholderNODE.classList.contains('negative')
                const countOfGlassInput = elem.querySelector('.counterInput')
                const currentCassette = cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].cassettes[index];

                if (isDelete) {
                    const deletedGlassesIds = [...currentCassette.glasses]
                        .reverse()
                        .slice(0, +countOfGlassInput.value)
                        .map(({id}) => id);

                    fetch(`${API_BASE_URL}/api/glasses/delete`, {
                        method: "DELETE",
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            glass_ids: deletedGlassesIds,
                        })
                    })
                        .then(res => res.json())
                        .then(() => {
                            cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].cassettes[index].glasses = (
                                cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].cassettes[index].glasses
                                    .filter(glass => !deletedGlassesIds.includes(glass.id))
                            )
                            cases[lastActiveCaseIndex].glass_count -= +countOfGlassInput.value;
                            cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].glass_count -= +countOfGlassInput.value;

                            const glassContentNODE = elem.nextElementSibling;

                            [...glassContentNODE.querySelectorAll('.glassItem')].reverse().slice(0, +countOfGlassInput.value).forEach(elem => {
                                elem.remove()
                            })

                            glassContentNODE
                                .closest('.cassetteColumn')
                                .querySelector('.counterInput')
                                .setAttribute('data-delete-count', cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].cassettes[index].glasses.length + 1)
                            changeItemCountOnEntity()
                            glassPageIndex = scrollContent(null, ".glassItems", "#glassItemsScroll", true, 0)
                            showSuccessAlert(`Скельц${+countOfGlassInput.value>1 ? "я" : "е"} успішно видаленн${+countOfGlassInput.value>1 ? "і" : "е"}`)
                            countOfGlassInput.value = 1;
                            changePrintInModel()
                        })
                }

                if (!isDelete) {
                    createGlassHandler(elem, index, {
                        cassette_id: currentCassette.id,
                        staining_type: placeholderNODE.dataset.glassPaintId,
                        num_glasses: +countOfGlassInput.value,
                    })
                }

                counterReset()
            })


            createGlassAndPrintBtnNODE.addEventListener('click', () => {
                const placeholderNODE = createGlassBtnNODE.closest('.placeholder')
                const countOfGlassInput = elem.querySelector('.counterInput')
                const currentCassette = cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].cassettes[index];

                createGlassHandler(elem, index, {
                    cassette_id: currentCassette.id,
                    staining_type: placeholderNODE.dataset.glassPaintId,
                    num_glasses: +countOfGlassInput.value,
                }, "?printing=true")
            })
        })
    }

    //GENERAL EVENTS
    const changeEntityCountHandler = (queryNODE) => {
        const inputsCounterNODE = document.querySelectorAll(queryNODE);
        const increaseNumber = (currentInputNODE, currentCounterNODE) => {
            if (currentInputNODE.value === "99") {
                return;
            }
            const newValue = +currentInputNODE.value + 1;

            currentInputNODE.value = newValue
            currentInputNODE.dispatchEvent(new Event('input'))


            const notNegative = currentCounterNODE.classList.contains('notNegative');

            if(notNegative){
                currentCounterNODE.querySelector('.counterAction').style.display = "block"
                return;
            }

            const isNegative = currentCounterNODE.classList.contains('negative');
            if (isNegative) {
                const maxDeleteCount = +currentInputNODE.dataset.deleteCount;
                if (newValue > maxDeleteCount) {
                    currentInputNODE.value = +currentInputNODE.value - 1
                }
            }
        }
        const decreaseNumber = (currentInputNODE, currentCounterNODE) => {
            const newValue = +currentInputNODE.value - 1
            if (currentInputNODE.value === "1") {
                if (!+currentInputNODE.dataset.deleteCount) {
                    return;
                }


                const isNegative = currentCounterNODE.classList.contains('negative');
                const classListMethod = isNegative ? "remove" : "add";
                const placeholderNODE = currentCounterNODE.closest('.placeholder');
                const createActionBtn = placeholderNODE.querySelector('.actionButton.create')
                const createActionBtnIcon = createActionBtn.querySelector('img')
                const createActionBtnIconSrc = isNegative ? "plusCircle" : "minusCircle";

                currentCounterNODE.classList[classListMethod]('negative')
                placeholderNODE.classList[classListMethod]('negative')
                createActionBtn.classList[classListMethod]('delete')
                createActionBtnIcon.setAttribute('src', `./assets/${createActionBtnIconSrc}.svg`);

                return;
            }

            const notNegative = currentCounterNODE.classList.contains('notNegative');

            if(newValue === 1 && notNegative){
                currentCounterNODE.querySelector('.counterAction').style.display = "none"
            }

            currentInputNODE.value = +currentInputNODE.value - 1
            currentInputNODE.dispatchEvent(new Event('input'))
        }

        inputsCounterNODE.forEach(currentInput => {
            const currentCounterNODE = currentInput.closest('.counter');
            currentInput.previousElementSibling.addEventListener("click", (e) => {
                if (currentCounterNODE.classList.contains('negative')) {
                    increaseNumber(currentInput, currentCounterNODE)
                    return;
                }

                decreaseNumber(currentInput, currentCounterNODE)
            })
            currentInput.nextElementSibling.addEventListener("click", (e) => {
                if (currentCounterNODE.classList.contains('negative')) {
                    decreaseNumber(currentInput, currentCounterNODE)
                    return;
                }

                increaseNumber(currentInput, currentCounterNODE)
            })

            currentInput.addEventListener('paste', (e) => {
                let paste = (e.clipboardData || window.clipboardData).getData("text");

                if (isNaN(paste)) {
                    e.preventDefault()
                }

                if (paste > 99) {
                    e.preventDefault()
                    currentInput.value = 99
                }

                if (paste < 1) {
                    e.preventDefault()
                    currentInput.value = 1
                }
            })
        })
    }
    const changeItemCountOnEntity = () => {
        const activeCaseNODE = document.querySelector('.caseItem.active')
        const activeSpecimenNODE = document.querySelector('.specimenItem.active')

        const currentCase = cases[lastActiveCaseIndex]
        const currentSpecimen = cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex]

        activeCaseNODE.querySelector(".caseItemImgCount").textContent = currentCase.bank_count
        activeCaseNODE.querySelector(".infoPlate.cassette").textContent = currentCase.cassette_count
        activeCaseNODE.querySelector(".infoPlate.glass").textContent = currentCase.glass_count
        activeSpecimenNODE.querySelector(".infoPlate.cassette").textContent = currentSpecimen.cassette_count
        activeSpecimenNODE.querySelector(".infoPlate.glass").textContent = currentSpecimen.glass_count
    }
    const addActiveClass = (className, isActiveIndex) => {
        document.querySelectorAll(className).forEach(elem => {
            elem.classList.remove('active')
        })

        document.querySelector(`${className}:nth-child(${isActiveIndex + 1 || 1})`).classList.add("active");
    }
    const counterReset = () => {
        const allPlaceholder = document.querySelectorAll('.placeholder');
        allPlaceholder.forEach(elem => {

            elem.classList.remove('negative')
            elem.querySelector('.counter').classList.remove('negative')
            elem.querySelector('.actionButton.create').classList.remove('delete')
            elem.querySelector('.actionButton.create img').setAttribute('src',  `./assets/plusCircle.svg`)
        })}
    const changeMacroDescription = () => {
        macroDescriptionTextareaNODE.nextElementSibling.addEventListener('click', () => {
            const currentSample = cases[lastActiveCaseIndex]?.samples[lastActiveSpecimenIndex];

            fetch(`${API_BASE_URL}/api/samples/macrodescription/${currentSample.id}`, {
                method: "PUT",
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    macro_description: macroDescriptionTextareaNODE.value.trim(),
                })
            })
                .then(res => res.json())
                .then(() => {
                    showSuccessAlert('Макро опис успішно оновлений')

                    macroDescriptionTextareaNODE.nextElementSibling.classList.remove('open');
                })
        })
    }
    const switchRole = () => {
        const roles = decodeToken(getToken())?.roles;

        if(roles?.includes('doctor')){
            const headerNODE = document.querySelector('.role-container')
            const toggleDiv = document.createElement('div');
            toggleDiv.classList.add('role-toggle')
            toggleDiv.innerHTML = `
            <div class="role-toggle">
                <button class="role-btn doc">Лікар</button>
                <button class="role-btn lab active">Лаборант</button>
            </div>
            `
            headerNODE.append(toggleDiv)

            document.querySelector('.role-toggle .role-btn:not(.active)').addEventListener('click', (e) => {
                window.location.href = `/static/glass.html?userCorId=${PATIENT_COR_ID}`
            })
        }
    }


    const goToCasesHandler = () => {
        document.querySelector('#goToCases')?.addEventListener('click', () => {
            window.location.href = `/static/doctor_patients_page.html`
        })
    }
</script>
<script>
    document.addEventListener("DOMContentLoaded", (event) => {
        helpTextShowHendler(document)
        createOrDeleteCaseHandler()
        createOrDeleteSpecimenHandler()
        createOrDeleteCassetteHandler()
        changeEntityCountHandler(".counter input")

        changeMacroDescription()
        setAllCases()

        showTextareaButton('sampleMacroDescription')
        switchRole()
        goToCasesHandler()
    });
</script>
<script>
    //PICK MARK
    let parentMark = "Standard";
    let childMark = "Resectio";

    document.addEventListener("DOMContentLoaded", (event) => {
        const parentMarkNODE = document.querySelectorAll('#parentMark .casePlate');
        const childMarkNODE = document.querySelectorAll('#childMark .casePlate');

        parentMarkNODE.forEach(elem => {
            elem.addEventListener("click", (e) => {
                parentMarkNODE.forEach(elem => elem.classList.remove('active'))
                const currentElem = e.target;

                currentElem.classList.add('active')

                parentMark = currentElem.dataset.value;
            })
        })

        childMarkNODE.forEach(elem => {
            elem.addEventListener("click", (e) => {
                childMarkNODE.forEach(elem => elem.classList.remove('active'))
                const currentElem = e.target;

                currentElem.classList.add('active')

                childMark = currentElem.dataset.value;
            })
        })
    });
</script>
<script>
    //ARROWS
    document.addEventListener("DOMContentLoaded", (event) => {
        const arrowsCase = document.querySelectorAll("#caseItemsScroll div");

        arrowsCase.forEach(elem => {
            elem.addEventListener("click", e => {
                casePageIndex = scrollContent(e, '#caseItems', "#caseItemsScroll", true, casePageIndex)
            })
        })
    });

    document.addEventListener("DOMContentLoaded", (event) => {
        const arrowsCase = document.querySelectorAll("#specimenItemsScroll div");

        arrowsCase.forEach(elem => {
            elem.addEventListener("click", e => {
                specimenPageIndex = scrollContent(e, "#specimenItems", "#specimenItemsScroll", true, specimenPageIndex)
            })
        })
    });

    document.addEventListener("DOMContentLoaded", (event) => {
        const arrowsCase = document.querySelectorAll("#cassetteItemsScroll div");

        arrowsCase.forEach(elem => {
            elem.addEventListener("click", e => {
                cassettePageIndex = scrollContent(e, "#cassetteItems", "#cassetteItemsScroll", false, cassettePageIndex)
            })
        })
    });

    document.addEventListener("DOMContentLoaded", (event) => {
        const arrowsGlass = document.querySelectorAll("#glassItemsScroll div");

        arrowsGlass.forEach(elem => {
            elem.addEventListener("click", e => {
                glassPageIndex = scrollContent(e, ".glassItems", "#glassItemsScroll", true, glassPageIndex)
            })
        })
    });
</script>
<script>
    //CASSETTE COMMENT
    document.addEventListener("DOMContentLoaded", (event) => {
        cassetteCommentModalNODE.querySelector('.modalSubmit').addEventListener('click', () => {
            const textareaNODE = cassetteCommentModalNODE.querySelector('textarea')

            const cassetteId = cassetteCommentModalNODE.dataset.id;
            const cassetteIndex = +cassetteCommentModalNODE.dataset.index;
            const commentValue = textareaNODE.value.trim();

            fetch(`${API_BASE_URL}/api/cassettes/${cassetteId}`, {
                method: "PATCH",
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    comment: commentValue,
                })
            })
                .then(res => res.json())
                .then(() => {
                    cases[lastActiveCaseIndex].samples[lastActiveSpecimenIndex].cassettes[cassetteIndex].comment = commentValue;
                    const commentIconSrc = commentValue.length ? "commentActive" : "comment";

                    cassetteContentNODE
                        .querySelector(`.cassetteColumn:nth-child(${cassetteIndex + 1}) .cassetteComment img`)
                        .setAttribute('src', `./assets/${commentIconSrc}.svg`);

                    cassetteCommentModalNODE.classList.remove('open')
                })
        })
    });
</script>

<script src="./js/modal.js"></script>
<script src="./js/caseSettings.js"></script>
<script src="./js/directionModal.js"></script>

</body>
</html>
